<script>
        // ----------------------------------------------------------------
        // CONFIGURACI√ìN DE POWER AUTOMATE / SHAREPOINT (Back-end)
        // ----------------------------------------------------------------
        
        let campaignsData = {}; 
        
        // üö® 1. TUS URLS DE POWER AUTOMATE AQU√ç 
        const API_URLS = {
            GET_ALL: "https://default766718c896324ea7994391931c2503.98.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2121deecc6d84f588d61ac5ab56e2772/triggers/manual/paths/invoke?api-version=1", 
            POST_CREATE: "https://default766718c896324ea7994391931c2503.98.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/325f819809aa46e0a9b0200a623f5cb9/triggers/manual/paths/invoke?api-version=1",
            PATCH_UPDATE: "https://default766718c896324ea7994391931c2503.98.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/b45ee2aafb43407eb468a9423179c462/triggers/manual/paths/invoke?api-version=1"
        };
        
        // El modo simulador ya no es necesario
        document.getElementById('user-id-display').textContent = '‚ú® **Modo Productivo Activo** (Datos le√≠dos/escritos en Microsoft Lists)';


        // ----------------------------------------------------------------
        // Utiler√≠as (Sin Cambios)
        // ----------------------------------------------------------------
        const PHASES = [
            'Inicio de Campa√±a',
            'Entrega de contenedores',
            'Arranque',
            '1RA Recolecci√≥n',
            '√öltima Recolecci√≥n',
            'Cierre'
        ];
        
        // Funci√≥n para adaptar los datos de SharePoint al formato de tu app
        const transformSharePointData = (spItems) => {
            const transformedData = {};
            if (!spItems || !Array.isArray(spItems)) return transformedData;

            spItems.forEach(item => {
                // NOTA: Ajusta los nombres de las propiedades (ej: item.Title, item.Contacto)
                // para que coincidan EXACTAMENTE con las columnas de tu lista de SharePoint.
                // SharePoint usa 'Title' para el nombre principal.
                
                // Aseg√∫rate de que tu columna de historial de fases (PhaseLog) sea de tipo JSON
                const phaseLog = item.PhaseLog ? JSON.parse(item.PhaseLog) : {}; 

                transformedData['camp-' + item.ID] = {
                    id: 'camp-' + item.ID, 
                    name: item.Title || 'Campa√±a sin nombre', 
                    contact: item.Contacto || 'N/A', // <-- Revisa este nombre de columna
                    phone: item.Telefono || 'N/A',   // <-- Revisa este nombre de columna
                    location: item.Ubicacion || 'N/A', // <-- Revisa este nombre de columna
                    comments: item.Comentarios || 'Sin comentarios iniciales.',
                    totalKilos: item.TotalKilos || 0,
                    status: item.Status || PHASES[0], // <-- Revisa este nombre de columna
                    startDate: item.StartDate || new Date().toISOString(), 
                    endDate: item.EndDate || null,
                    phases: phaseLog 
                };
            });
            return transformedData;
        };
        
        const getPhaseDate = (campaign, phaseName) => {            
            const phaseData = campaign.phases && campaign.phases[phaseName];
            if (phaseData) {                
                return typeof phaseData === 'string' ? phaseData : phaseData.date;            
            }            
            return null;        
        };
        
        const calculateDuration = (startDate, endDate) => {            
            const start = new Date(startDate);            
            const end = endDate ? new Date(endDate) : new Date();            
            const diffTime = Math.abs(end - start);            
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));            
            return diffDays;        
        };
        
        const pad = (n) => (n < 10 ? '0' + n : n);        
        const formatDateTime = (date) => {            
            return date.getUTCFullYear() +                    
                    pad(date.getUTCMonth() + 1) +                    
                    pad(date.getUTCDate()) + 'T' +                    
                    pad(date.getUTCHours()) +                    
                    pad(date.getUTCMinutes()) +                    
                    pad(date.getUTCSeconds()) + 'Z';        
        };
        
        window.alertModal = (title, body) => {
            const modal = document.getElementById('alert-modal');
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-body').textContent = body;
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
        };
        
        window.closeModal = (id) => {
            const modal = document.getElementById(id);
            modal.classList.add('hidden', 'opacity-0');
            modal.classList.remove('opacity-100');
        };

        // ----------------------------------------------------------------
        // [2] FUNCI√ìN DE LECTURA (Reemplaza loadCampaigns de localStorage)
        // ----------------------------------------------------------------
        const loadCampaigns = async () => {
            try {
                // Llama a tu flujo GET
                const response = await fetch(API_URLS.GET_ALL);
                if (!response.ok) throw new Error("Error al cargar datos de SharePoint.");
                
                // Asumiendo que el flujo devuelve un objeto con la propiedad 'value' (lista de elementos)
                const data = await response.json(); 
                
                campaignsData = transformSharePointData(data.value); 
                
            } catch (error) {
                console.error("Error al cargar campa√±as:", error);
                alertModal("Error de Conexi√≥n", "No se pudieron cargar las campa√±as. Revisa la URL y los permisos del Flujo 1.");
            } finally {
                renderAllCampaigns(); 
            }
        };

        // Esta funci√≥n ya NO guarda nada localmente. Solo recarga la vista.
        const saveCampaigns = () => {
            renderAllCampaigns();
        };

        // ----------------------------------------------------------------
        // [3] FUNCI√ìN CENTRAL DE ACTUALIZACI√ìN (Para avance de fase y cierre)
        // ----------------------------------------------------------------
        const updateCampaignStatus = async (spId, newStatus, comment = '', kilos = 0) => {
            const dataToSend = {
                id: parseInt(spId), // El ID de SharePoint debe ser un n√∫mero
                newStatus: newStatus,
                comment: comment,
                kilos: kilos 
            };

            try {
                const response = await fetch(API_URLS.PATCH_UPDATE, {
                    method: 'POST', // Los flujos de Power Automate usan POST para el PATCH
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });

                if (!response.ok) throw new Error("Error al actualizar la campa√±a en SharePoint.");
                
                // Recargar los datos para que el cambio se refleje
                await loadCampaigns(); 
                return true;

            } catch (error) {
                console.error("Error de actualizaci√≥n:", error);
                alertModal("Error de Actualizaci√≥n", "Hubo un problema al actualizar la fase/kilos. Revisa el Flujo 3.");
                return false;
            }
        };

        // ----------------------------------------------------------------
        // L√≥gica Principal (CRUD Simulada, ahora con Fetch)
        // ----------------------------------------------------------------
        
        const renderAllCampaigns = () => {
            const campaigns = Object.values(campaignsData);
            
            // ... (El resto de esta funci√≥n no cambia)
            const activeCampaigns = campaigns.filter(c => c.status !== 'Cierre');            
            const closedCampaigns = campaigns.filter(c => c.status === 'Cierre');
            
            renderCampaigns(activeCampaigns, document.getElementById('active-campaigns-list'), 'activas');            
            renderCampaigns(closedCampaigns, document.getElementById('closed-campaigns-list'), 'cerradas');        
        };                
        
        // [4] Agregar Campa√±a (Reemplaza la l√≥gica de localStorage)
        document.getElementById('add-campaign-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('campaign-name').value;
            const contact = document.getElementById('campaign-contact').value;
            const phone = document.getElementById('campaign-phone').value;
            const location = document.getElementById('campaign-location').value;
            const comments = document.getElementById('campaign-comments').value || 'Sin comentarios iniciales.';

            if (!name || !contact || !phone || !location) {
                alertModal("Campos Incompletos", "Por favor, complete todos los campos obligatorios.");
                return;
            }
            
            // El formato JSON debe coincidir exactamente con el JSON Schema de tu Flujo 2
            const dataToSend = {
                name,
                contact,
                phone: phone.replace(/[^0-9+]/g, ''),
                location,
                comments
            };

            try {
                // Llama a tu flujo POST
                const response = await fetch(API_URLS.POST_CREATE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });

                if (!response.ok) throw new Error("Error al crear campa√±a en SharePoint.");
                
                // Si tiene √©xito, recarga los datos para que aparezca la nueva campa√±a
                await loadCampaigns();
                
                e.target.reset();
                alertModal("Campa√±a Agregada", `La campa√±a "${name}" ha sido iniciada y guardada en Microsoft Lists.`);

            } catch (error) {
                console.error("Error al crear campa√±a:", error);
                alertModal("Error de Creaci√≥n", "Hubo un problema al guardar la campa√±a. Revisa el Flujo 2.");
            }
        });

        // [5] Avanzar Fase (Modificado para usar updateCampaignStatus)
        window.advancePhase = (campaignIdWithPrefix, currentStatus) => {
            const currentIndex = PHASES.indexOf(currentStatus);
            if (currentIndex === -1 || currentIndex === PHASES.length - 1) {
                alertModal("Estado Final", "Esta campa√±a ya ha completado todas sus fases.");
                return;
            }                        
            const nextPhase = PHASES[currentIndex + 1];
            const campaign = campaignsData[campaignIdWithPrefix];                        

            if (currentStatus === '√öltima Recolecci√≥n') {
                openKilosModal(campaign);
                return;
            }

            openAdvanceCommentModal(campaign, nextPhase);        
        };                
        
        // Modal para captura de Kilos (Modificado para usar updateCampaignStatus)
        const openKilosModal = (campaign) => {
            const modal = document.getElementById('kilos-modal');
            document.getElementById('kilos-modal-title').textContent = `Transici√≥n a Cierre: ${campaign.name}`;
            document.getElementById('kilos-campaign-id').value = campaign.id;
            document.getElementById('kilos-next-phase').value = 'Cierre'; 
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
        };

        document.getElementById('kilos-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const campaignIdWithPrefix = document.getElementById('kilos-campaign-id').value;
            const campaignId = campaignIdWithPrefix.replace('camp-', ''); // ID de SharePoint
            const nextPhase = document.getElementById('kilos-next-phase').value;
            const comment = document.getElementById('campaign-kilos-comment').value || 'Campa√±a cerrada al registrar kilos.';
            const kilos = parseFloat(document.getElementById('campaign-kilos-input').value);
            const campaign = campaignsData[campaignIdWithPrefix];

            if (isNaN(kilos) || kilos < 0) {
                alertModal("Error de Kilos", "Por favor, introduce una cantidad v√°lida y positiva de kilos.");
                return;
            }

            const success = await updateCampaignStatus(campaignId, nextPhase, comment, kilos);

            if (success) {
                closeModal('kilos-modal');
                e.target.reset();
                alertModal("Campa√±a Cerrada", `La campa√±a "${campaign.name}" ha sido cerrada con ${kilos} Kg. (Datos guardados en Lista).`);
            }
        });
        
        // Modal para comentarios de avance (excepto cierre) (Modificado para usar updateCampaignStatus)
        const openAdvanceCommentModal = (campaign, nextPhase) => {
            const modal = document.getElementById('advance-comment-modal');
            document.getElementById('advance-comment-modal-title').textContent = `Avanzar a: ${nextPhase}`;
            document.getElementById('advance-campaign-name-display').textContent = campaign.name;                        
            document.getElementById('advance-campaign-id').value = campaign.id;
            document.getElementById('advance-next-phase').value = nextPhase;
            document.getElementById('advance-comment-input').value = '';                         
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
        };

        document.getElementById('advance-comment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const campaignIdWithPrefix = document.getElementById('advance-campaign-id').value;
            const nextPhase = document.getElementById('advance-next-phase').value;
            const comment = document.getElementById('advance-comment-input').value;
            
            await processPhaseAdvancement(campaignIdWithPrefix, nextPhase, comment);
        });

        window.processPhaseAdvancement = async (campaignIdWithPrefix, nextPhase, comment) => {
            const campaignId = campaignIdWithPrefix.replace('camp-', ''); // ID de SharePoint
            const success = await updateCampaignStatus(campaignId, nextPhase, comment);
            
            if (success) {
                closeModal('advance-comment-modal');
                alertModal("Fase Avanzada", `Campa√±a actualizada a la fase: "${nextPhase}" (Datos guardados en Lista).`);
            }
        };                
        
        // Funci√≥n para editar fecha (Modificado, ahora usa updateCampaignStatus)
        window.openEditDateModal = (campaignId, phaseName, phaseData) => {
            // ... (sin cambios en la apertura del modal)
            const currentPhaseDateISO = getPhaseDate({phases: {[phaseName]: phaseData}}, phaseName);

            let localDateTime = '';
            if (currentPhaseDateISO) {
                const d = new Date(currentPhaseDateISO);
                localDateTime = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
            }                        
            document.getElementById('edit-date-modal-title').textContent = `Editar Fecha de: ${phaseName}`;
            document.getElementById('edit-campaign-id').value = campaignId;
            document.getElementById('edit-phase-name').value = phaseName;
            document.getElementById('edit-phase-date').value = localDateTime;
            document.getElementById('edit-phase-comment').value = phaseData.comment || '';

            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
        };

        document.getElementById('edit-date-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const campaignIdWithPrefix = document.getElementById('edit-campaign-id').value;
            const campaignId = campaignIdWithPrefix.replace('camp-', '');
            const phaseName = document.getElementById('edit-phase-name').value;
            const newDateLocal = document.getElementById('edit-phase-date').value;
            const newComment = document.getElementById('edit-phase-comment').value || 'Sin comentarios log√≠sticos.';

            if (!newDateLocal) {
                alertModal("Error", "Por favor, selecciona una fecha y hora v√°lidas.");
                return;
            }                        
            const newDateISO = new Date(newDateLocal).toISOString();
            
            // L√≥gica de actualizaci√≥n local removida. Ahora se env√≠a a SharePoint.
            // La fecha y el comentario se actualizar√°n a trav√©s del Flujo 3.
            
            const dataToSend = {
                id: parseInt(campaignId), 
                phaseName: phaseName, 
                newDate: newDateISO,
                comment: newComment 
            };
            
            try {
                // Se necesita un flujo adicional para manejo de fechas o ajustar Flujo 3
                // Para simplificar, ajustaremos el Flujo 3 para que acepte phaseName, newDate, comment
                const response = await fetch(API_URLS.PATCH_UPDATE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });
                
                if (!response.ok) throw new Error("Error al actualizar fecha en SharePoint.");
                
                await loadCampaigns(); // Recarga para ver el cambio
                
                closeModal('edit-date-modal');
                alertModal("Fecha Actualizada", `La fecha y nota de la fase "${phaseName}" han sido modificadas.`);
                
            } catch (error) {
                console.error("Error de actualizaci√≥n de fecha:", error);
                alertModal("Error de Actualizaci√≥n", "Hubo un problema al guardar la nueva fecha. Verifica que tu Flujo 3 pueda manejar fechas.");
            }
        });
        
        // Modal para ver comentarios (sin cambios)
        window.viewPhaseComment = (phaseName, comment) => {
            alertModal(`Nota de la Fase: ${phaseName}`, comment || 'No se registraron comentarios para esta fase.');
        };
        
        // ----------------------------------------------------------------        
        // Funciones de Automatizaci√≥n (Agendar e WP) - No requieren cambios, 
        // ya que solo leen los datos cargados en 'campaignsData'.
        // ----------------------------------------------------------------                
        
        window.generateIcsForPhase = (campaignJsonString, phaseName, phaseDataString) => {
            // ... (sin cambios)
        };
        
        window.sendWhatsAppMessageForPhase = (campaignJsonString, phaseName, phaseDataString) => {
            // ... (sin cambios)
        };
        
        window.sendWhatsAppMessageForCierre = (campaignJsonString) => {
            // ... (sin cambios)
        };

        window.generateIcsForCierre = (campaignJsonString) => {
            // ... (sin cambios)
        };
        
        // ----------------------------------------------------------------        
        // L√≥gica de Renderizado y Carga Inicial
        // ----------------------------------------------------------------        
        const renderCampaigns = (campaigns, container, type) => {
            // ... (sin cambios)
            container.innerHTML = '';                         
            campaigns.sort((a, b) => new Date(getPhaseDate(b, 'Inicio de Campa√±a') || b.startDate) - new Date(getPhaseDate(a, 'Inicio de Campa√±a') || a.startDate)); 

            if (campaigns.length === 0) {                
                const message = type === 'activas' ?                     
                    `¬°No hay campa√±as activas! Inicia una nueva campa√±a para verla aqu√≠.` :                    
                    `Las campa√±as cerradas aparecer√°n aqu√≠.`;                
                container.innerHTML = `<p class="text-gray-500 text-center p-6 bg-white rounded-xl">${message}</p>`;                
                return;            
            }
            
            campaigns.forEach(campaign => {                
                const startDateISO = getPhaseDate(campaign, 'Inicio de Campa√±a') || campaign.startDate;                
                const endDateISO = getPhaseDate(campaign, 'Cierre') || campaign.endDate;                
                const durationDays = calculateDuration(startDateISO, endDateISO);                
                const isCompleted = campaign.status === 'Cierre';                
                const currentIndex = PHASES.indexOf(campaign.status);                
                const nextPhase = PHASES[currentIndex + 1];
                
                // ... (el resto del renderizado, incluyendo la generaci√≥n del HTML de las tarjetas)
                const efficiency = (campaign.totalKilos > 0 && durationDays > 0) ? (durationDays / campaign.totalKilos).toFixed(2) : 'N/A';
                let efficiencyText = '';
                if (isCompleted) {
                    const efficiencyValue = parseFloat(efficiency);
                    const efficiencyClass = efficiency !== 'N/A' && efficiencyValue > 0 && efficiencyValue < 0.5 ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800';
                    efficiencyText = `                        
                        <div class="flex flex-col items-end">                            
                            <span class="text-sm text-gray-700">Eficiencia (D√≠as/Kg):</span>                            
                            <span class="text-[0.8rem] font-bold ${efficiencyClass} rounded-md px-2 py-0.5">                                
                                ${efficiency}                            
                            </span>                        
                        </div>                    
                    `;
                }

                const campaignJsonString = JSON.stringify(campaign).replace(/"/g, '&quot;');

                const advanceButton = isCompleted ? '' : `                    
                    <button onclick="window.advancePhase('${campaign.id}', '${campaign.status}')" class="bg-indigo-500 text-white text-xs px-3 py-1 rounded-full hover:bg-indigo-600 transition">                        
                        <span class="font-bold">Avanzar a:</span> ${nextPhase}                    
                    </button>                
                `;

                const daysStatus = isCompleted ? `Cerrada (${durationDays} D√≠as)` : `Activa (D√≠a ${durationDays}`;
                
                // Final del bucle, c√≥digo omitido por ser repetitivo
                // ...
            });
        };

        // Carga inicial al iniciar la p√°gina.
        document.addEventListener('DOMContentLoaded', loadCampaigns);
    </script>
