<!DOCTYPE html>
<html lang="es">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Seguimiento de CampaÃ±as - SIMULADOR 2026</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>

Â  Â  Â  Â  Â  Â  <link rel="icon" type="image/png" href="Logo_PC_Vectores-02 (3).png">
Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <style>
Â  Â  Â  Â  .campaign-card {
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
Â  Â  Â  Â  Â  Â  transition: transform 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .campaign-card:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  }
Â  Â  Â  Â  .phase-complete {
Â  Â  Â  Â  Â  Â  background-color: #d1fae5;
Â  Â  Â  Â  Â  Â  color: #065f46;
Â  Â  Â  Â  }
Â  Â  Â  Â  .phase-active {
Â  Â  Â  Â  Â  Â  background-color: #fffbeb;
Â  Â  Â  Â  Â  Â  color: #b45309;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  border-left: 4px solid #f59e0b;
Â  Â  Â  Â  }
Â  Â  Â  Â  .timeline-item {
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  padding-top: 8px;Â 
Â  Â  Â  Â  Â  Â  padding-bottom: 8px;
Â  Â  Â  Â  Â  Â  min-width: 80px;Â 
Â  Â  Â  Â  Â  Â  margin-right: 4px;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .timeline-item-container {
Â  Â  Â  Â  Â  Â  overflow-x: auto;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Modal Backdrop */
Â  Â  Â  Â  .modal-backdrop {
Â  Â  Â  Â  Â  Â  transition: opacity 0.3s ease-in-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-container {
Â  Â  Â  Â  Â  Â  transition: transform 0.3s ease-in-out;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="container mx-auto p-6 lg:p-12">
Â  Â  Â  Â  <header class="mb-8">
Â  Â  Â  Â  Â  Â  <h1 class="text-4xl font-bold text-gray-800 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 mr-3 text-indigo-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Dashboard de CampaÃ±as
Â  Â  Â  Â  Â  Â  </h1>
Â  Â  Â  Â  Â  Â  <p id="user-id-display" class="text-sm text-gray-500 mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  ğŸŒ **Modo Power Automate Activo** (Datos respaldados en SharePoint/Microsoft List)
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  </header>

Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl mb-8 shadow-md">
Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-semibold text-gray-700 mb-4">â• Iniciar Nueva CampaÃ±a</h2>
Â  Â  Â  Â  Â  Â  <form id="add-campaign-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="campaign-name" placeholder="Nombre de la CampaÃ±a *" required class="p-2 border border-gray-300 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="campaign-contact" placeholder="Contacto Principal *" required class="p-2 border border-gray-300 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" id="campaign-phone" placeholder="TelÃ©fono de Contacto *" required class="p-2 border border-gray-300 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="campaign-location" placeholder="UbicaciÃ³n/DirecciÃ³n *" required class="p-2 border border-gray-300 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="campaign-comments" placeholder="Comentarios Iniciales (Opcional)" rows="1" class="p-2 border border-gray-300 rounded-lg md:col-span-2"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out md:col-span-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Crear CampaÃ±a
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <hr class="my-8">

Â  Â  Â  Â  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
Â  Â  Â  Â  Â  Â  <section>
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold text-indigo-700 mb-4">ğŸ”¥ CampaÃ±as Activas</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="active-campaigns-list" class="space-y-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section>
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold text-gray-600 mb-4">âœ… CampaÃ±as Cerradas</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="closed-campaigns-list" class="space-y-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </section>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="alert-modal" class="modal-backdrop fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden opacity-0 z-50"
Â  Â  Â  Â  Â onclick="this.classList.add('hidden', 'opacity-0'); this.classList.remove('opacity-100');">
Â  Â  Â  Â  <div class="modal-container bg-white rounded-lg p-6 shadow-xl w-full max-w-sm mx-4" onclick="event.stopPropagation()">
Â  Â  Â  Â  Â  Â  <h3 id="alert-modal-title" class="text-lg font-bold text-gray-900 mb-3">TÃ­tulo</h3>
Â  Â  Â  Â  Â  Â  <p id="alert-modal-body" class="text-sm text-gray-700 mb-4">Cuerpo del mensaje.</p>
Â  Â  Â  Â  Â  Â  <div class="flex justify-end">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="document.getElementById('alert-modal').classList.add('hidden', 'opacity-0'); document.getElementById('alert-modal').classList.remove('opacity-100');"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700 transition">Aceptar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <script>
Â  Â  // CONFIGURACIÃ“N DE POWER AUTOMATE / SHAREPOINT 
Â  Â  // ----------------------------------------------------------------

Â  Â  let campaignsData = {};Â 

Â  Â  // ğŸš¨ TUS URLS DE POWER AUTOMATE AQUÃÂ 
Â  Â  const API_URLS = {
Â  Â  Â  Â  GET_ALL: "https://default766718c896324ea7994391931c2503.98.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2121deecc6d84f588d61ac5ab56e2772/triggers/manual/paths/invoke?api-version=1",Â 
Â  Â  Â  Â  POST_CREATE: "https://default766718c896324ea7994391931c2503.98.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/325f819809aa46e0a9b0200a623f5cb9/triggers/manual/paths/invoke?api-version=1",
Â  Â  Â  Â  PATCH_UPDATE: "https://default766718c896324ea7994391931c2503.98.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/b45ee2aafb43407eb468a9423179c462/triggers/manual/paths/invoke?api-version=1"
Â  Â  };

Â  Â  // FASES ASUMIDAS (Ajusta si son diferentes)
Â  Â  const PHASES = ['Inicio de CampaÃ±a', 'DiseÃ±o', 'InstalaciÃ³n', 'Ãšltima RecolecciÃ³n', 'Cierre'];

Â  Â  // Funciones de Utilidad (Necesarias para el resto de tu cÃ³digo)
Â  Â  const pad = (num) => (num < 10 ? '0' : '') + num;
Â  Â  const formatDateTime = (date) => date.toISOString().replace(/[-:.]/g, '').replace('T', '').slice(0, 15) + 'Z';
Â  Â  const calculateDuration = (start, end) => {
Â  Â  Â  Â  if (!start) return 0;
Â  Â  Â  Â  const endDate = end ? new Date(end) : new Date();
Â  Â  Â  Â  const diffTime = Math.abs(endDate - new Date(start));
Â  Â  Â  Â  return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
Â  Â  };
Â  Â  const getPhaseDate = (campaign, phaseName) => campaign.phases && campaign.phases[phaseName] ? campaign.phases[phaseName].date : null;
Â  Â  Â  Â  
Â  Â  // ğŸ’¡ IMPORTANTE: Ajusta estos nombres de columna para que coincidan con tu Microsoft List
Â  Â  const transformSharePointData = (dataArray) => {
Â  Â  Â  Â  const transformed = {};
Â  Â  Â  Â  dataArray.forEach(item => {
Â  Â  Â  Â  Â  Â  // Asume que el JSON de tu flujo tiene una propiedad 'value' que es un array.
Â  Â  Â  Â  Â  Â  // item.ID es el ID de SharePoint, crÃ­tico para la actualizaciÃ³n.
Â  Â  Â  Â  Â  Â  transformed[item.ID] = {
Â  Â  Â  Â  Â  Â  Â  Â  id: item.ID.toString(), 
Â  Â  Â  Â  Â  Â  Â  Â  name: item.Title, // Nombre interno de la columna
Â  Â  Â  Â  Â  Â  Â  Â  contact: item.Contacto, // Nombre interno de la columna
Â  Â  Â  Â  Â  Â  Â  Â  phone: item.Telefono, Â // Nombre interno de la columna
Â  Â  Â  Â  Â  Â  Â  Â  location: item.Ubicacion, // Nombre interno de la columna
Â  Â  Â  Â  Â  Â  Â  Â  comments: item.ComentariosIniciales, // Nombre interno de la columna
Â  Â  Â  Â  Â  Â  Â  Â  totalKilos: item.TotalKilos || 0, // Nombre interno de la columna
Â  Â  Â  Â  Â  Â  Â  Â  status: item.FaseActual, // Nombre interno de la columna
Â  Â  Â  Â  Â  Â  Â  Â  startDate: item.FechaInicio, // Nombre interno de la columna
Â  Â  Â  Â  Â  Â  Â  Â  endDate: item.FechaCierre, // Nombre interno de la columna
Â  Â  Â  Â  Â  Â  Â  Â  // 'FasesJson' debe ser la columna de texto/multilÃ­nea donde guardas el JSON de las fases
Â  Â  Â  Â  Â  Â  Â  Â  phases: item.FasesJson ? JSON.parse(item.FasesJson) : {},
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  });
Â  Â  Â  Â  return transformed;
Â  Â  };


Â  Â  // [2] FUNCIÃ“N DE LECTURA DE DATOS (GET)
Â  Â  // ----------------------------------------------------------------
Â  Â  const loadCampaigns = async () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(API_URLS.GET_ALL);
Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error("Error al cargar datos de SharePoint.");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const data = await response.json();Â 
Â  Â  Â  Â  Â  Â  campaignsData = transformSharePointData(data.value);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error al cargar campaÃ±as:", error);
Â  Â  Â  Â  Â  Â  alertModal("Error de ConexiÃ³n", "No se pudieron cargar las campaÃ±as. Revisa la URL y los permisos del Flujo GET (Flujo 1).");
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  renderAllCampaigns();Â 
Â  Â  Â  Â  }
Â  Â  };


Â  Â  // [3] FUNCIÃ“N CENTRAL DE ACTUALIZACIÃ“N (PATCH)
Â  Â  // ----------------------------------------------------------------
Â  Â  const updateCampaignStatus = async (spId, newStatus, comment = '', kilos = 0) => {
Â  Â  Â  Â  // Estos campos deben coincidir con lo que espera el Flujo 3 (PATCH_UPDATE)
Â  Â  Â  Â  const dataToSend = {
Â  Â  Â  Â  Â  Â  id: parseInt(spId), 
Â  Â  Â  Â  Â  Â  newStatus: newStatus,
Â  Â  Â  Â  Â  Â  comment: comment,
Â  Â  Â  Â  Â  Â  kilos: kilosÂ 
Â  Â  Â  Â  };

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(API_URLS.PATCH_UPDATE, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST', // Power Automate Trigger usa POST
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(dataToSend)
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error("Error al actualizar la campaÃ±a en SharePoint.");
Â  Â  Â  Â  Â  Â  await loadCampaigns();Â 
Â  Â  Â  Â  Â  Â  return true;

Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error de actualizaciÃ³n:", error);
Â  Â  Â  Â  Â  Â  alertModal("Error de ActualizaciÃ³n", "Hubo un problema al actualizar la fase/kilos. Revisa el Flujo PATCH (Flujo 3).");
Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  }
Â  Â  };

Â  Â  // [4] Agregar CampaÃ±a (POST)
Â  Â  // ----------------------------------------------------------------
Â  Â  document.getElementById('add-campaign-form').addEventListener('submit', async (e) => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  // Captura de valores
Â  Â  Â  Â  const name = document.getElementById('campaign-name').value;
Â  Â  Â  Â  const contact = document.getElementById('campaign-contact').value;
Â  Â  Â  Â  const phone = document.getElementById('campaign-phone').value;
Â  Â  Â  Â  const location = document.getElementById('campaign-location').value;
Â  Â  Â  Â  const comments = document.getElementById('campaign-comments').value || 'Sin comentarios iniciales.';

Â  Â  Â  Â  if (!name || !contact || !phone || !location) {
Â  Â  Â  Â  Â  Â  alertModal("Campos Incompletos", "Por favor, complete todos los campos obligatorios.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // El JSON enviado debe coincidir con el esquema de tu Flujo 2 (POST_CREATE)
Â  Â  Â  Â  const dataToSend = {
Â  Â  Â  Â  Â  Â  name,
Â  Â  Â  Â  Â  Â  contact,
Â  Â  Â  Â  Â  Â  phone: phone.replace(/[^0-9+]/g, ''),
Â  Â  Â  Â  Â  Â  location,
Â  Â  Â  Â  Â  Â  comments
Â  Â  Â  Â  };

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(API_URLS.POST_CREATE, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(dataToSend)
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error("Error al crear campaÃ±a en SharePoint.");
Â  Â  Â  Â  Â  Â  await loadCampaigns();
Â  Â  Â  Â  Â  Â  e.target.reset();
Â  Â  Â  Â  Â  Â  alertModal("CampaÃ±a Agregada", `La campaÃ±a "${name}" ha sido iniciada y guardada en Microsoft Lists.`);

Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error al crear campaÃ±a:", error);
Â  Â  Â  Â  Â  Â  alertModal("Error de CreaciÃ³n", "Hubo un problema al guardar la campaÃ±a. Revisa el Flujo POST (Flujo 2).");
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // ----------------------------------------------------------------
Â  Â  // Funciones de Modales y LÃ³gica Principal (Resto del JS)
Â  Â  // ----------------------------------------------------------------
Â  Â  
Â  Â  window.alertModal = (title, body) => {
Â  Â  Â  Â  const modal = document.getElementById('alert-modal');
Â  Â  Â  Â  document.getElementById('alert-modal-title').textContent = title;
Â  Â  Â  Â  document.getElementById('alert-modal-body').textContent = body;
Â  Â  Â  Â  modal.classList.remove('hidden', 'opacity-0');
Â  Â  Â  Â  modal.classList.add('opacity-100');
Â  Â  };

Â  Â  window.closeModal = (id) => {
Â  Â  Â  Â  const modal = document.getElementById(id);
Â  Â  Â  Â  modal.classList.add('hidden', 'opacity-0');
Â  Â  Â  Â  modal.classList.remove('opacity-100');
Â  Â  };
Â  Â  
Â  Â  // Resto de las funciones... (AsegÃºrate de copiar aquÃ­ el resto de las funciones que tenÃ­as, como:
Â  Â  // renderAllCampaigns, renderCampaigns, advancePhase, openKilosModal, openAdvanceCommentModal,
Â  Â  // openEditDateModal, generateIcsForPhase, sendWhatsAppMessageForPhase, etc.)
Â  Â  
Â  Â  // FUNCIÃ“N INICIAL
Â  Â  loadCampaigns();
Â  Â  </script>

</body>
</html>
