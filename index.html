
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Campa√±as - SIMULADOR 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .campaign-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .campaign-card:hover {
            transform: translateY(-2px);
        }
        .phase-complete {
            background-color: #d1fae5;
            color: #065f46;
        }
        .phase-active {
            background-color: #fffbeb;
            color: #b45309;
            font-weight: 600;
            border-left: 4px solid #f59e0b;
        }
        .timeline-item {
            position: relative;
            cursor: pointer;
            padding-top: 8px; 
            padding-bottom: 8px;
            min-width: 80px; 
            margin-right: 4px; 
        }
        .timeline-item-container {
            overflow-x: auto;
            white-space: nowrap;
        }
        /* Modal Backdrop */
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-container {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body>

    <div class="container mx-auto p-6 lg:p-12">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 mr-3 text-indigo-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
                Dashboard de Campa√±as
            </h1>
            <p id="user-id-display" class="text-sm text-gray-500 mt-1">
                ‚≠ê **Modo Simulador Activo** (Datos guardados en su navegador - LocalStorage)
            </p>
        </header>

        <div class="bg-white p-6 rounded-xl mb-8 shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">‚ûï Iniciar Nueva Campa√±a</h2>
            <form id="add-campaign-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="campaign-name" placeholder="Nombre de la Campa√±a *" required class="p-2 border border-gray-300 rounded-lg">
                <input type="text" id="campaign-contact" placeholder="Contacto Principal *" required class="p-2 border border-gray-300 rounded-lg">
                <input type="tel" id="campaign-phone" placeholder="Tel√©fono de Contacto *" required class="p-2 border border-gray-300 rounded-lg">
                <input type="text" id="campaign-location" placeholder="Ubicaci√≥n/Direcci√≥n *" required class="p-2 border border-gray-300 rounded-lg">
                <textarea id="campaign-comments" placeholder="Comentarios Iniciales (Opcional)" rows="1" class="p-2 border border-gray-300 rounded-lg md:col-span-2"></textarea>
                <button type="submit" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out md:col-span-3">
                    Crear Campa√±a
                </button>
            </form>
        </div>
        
        <hr class="my-8">

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <section>
                <h2 class="text-2xl font-semibold text-indigo-700 mb-4">üî• Campa√±as Activas</h2>
                <div id="active-campaigns-list" class="space-y-6">
                    </div>
            </section>

            <section>
                <h2 class="text-2xl font-semibold text-gray-600 mb-4">‚úÖ Campa√±as Cerradas</h2>
                <div id="closed-campaigns-list" class="space-y-6">
                    </div>
            </section>
        </div>
    </div>

    <div id="alert-modal" class="modal-backdrop fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden opacity-0 z-50"
         onclick="this.classList.add('hidden', 'opacity-0'); this.classList.remove('opacity-100');">
        <div class="modal-container bg-white rounded-lg p-6 shadow-xl w-full max-w-sm mx-4" onclick="event.stopPropagation()">
            <h3 id="alert-modal-title" class="text-lg font-bold text-gray-900 mb-3">T√≠tulo</h3>
            <p id="alert-modal-body" class="text-sm text-gray-700 mb-4">Cuerpo del mensaje.</p>
            <div class="flex justify-end">
                <button onclick="document.getElementById('alert-modal').classList.add('hidden', 'opacity-0'); document.getElementById('alert-modal').classList.remove('opacity-100');"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700 transition">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="kilos-modal" class="modal-backdrop fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden opacity-0 z-50">
        <div class="modal-container bg-white rounded-lg p-6 shadow-xl w-full max-w-md mx-4" onclick="event.stopPropagation()">
            <h3 id="kilos-modal-title" class="text-xl font-bold text-gray-900 mb-4">Transici√≥n a Cierre: [Nombre Campa√±a]</h3>
            <form id="kilos-form">
                <input type="hidden" id="kilos-campaign-id">
                <input type="hidden" id="kilos-next-phase">
                <div class="mb-4">
                    <label for="campaign-kilos-input" class="block text-sm font-medium text-gray-700">Total de Kilos Recolectados *</label>
                    <input type="number" step="0.01" min="0" id="campaign-kilos-input" required class="mt-1 p-2 border border-gray-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="campaign-kilos-comment" class="block text-sm font-medium text-gray-700">Nota de Cierre (Opcional)</label>
                    <textarea id="campaign-kilos-comment" rows="2" class="mt-1 p-2 border border-gray-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('kilos-modal').classList.add('hidden', 'opacity-0'); document.getElementById('kilos-modal').classList.remove('opacity-100');"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">Cancelar</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition">
                        Cerrar Campa√±a
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="advance-comment-modal" class="modal-backdrop fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden opacity-0 z-50">
        <div class="modal-container bg-white rounded-lg p-6 shadow-xl w-full max-w-md mx-4" onclick="event.stopPropagation()">
            <h3 id="advance-comment-modal-title" class="text-xl font-bold text-gray-900 mb-2">Avanzar a: [Fase]</h3>
            <p class="text-sm text-gray-500 mb-4">Campa√±a: <span id="advance-campaign-name-display" class="font-medium text-indigo-600"></span></p>
            <form id="advance-comment-form">
                <input type="hidden" id="advance-campaign-id">
                <input type="hidden" id="advance-next-phase">
                <div class="mb-6">
                    <label for="advance-comment-input" class="block text-sm font-medium text-gray-700">Nota Log√≠stica/Comentario (Opcional)</label>
                    <textarea id="advance-comment-input" rows="3" placeholder="Ej: Contenedores entregados sin problema. El arranque ser√° el lunes." class="mt-1 p-2 border border-gray-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('advance-comment-modal').classList.add('hidden', 'opacity-0'); document.getElementById('advance-comment-modal').classList.remove('opacity-100');"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition">
                        Confirmar Avance
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-date-modal" class="modal-backdrop fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden opacity-0 z-50">
        <div class="modal-container bg-white rounded-lg p-6 shadow-xl w-full max-w-md mx-4" onclick="event.stopPropagation()">
            <h3 id="edit-date-modal-title" class="text-xl font-bold text-gray-900 mb-4">Editar Fecha de: [Fase]</h3>
            <form id="edit-date-form">
                <input type="hidden" id="edit-campaign-id">
                <input type="hidden" id="edit-phase-name">
                <div class="mb-4">
                    <label for="edit-phase-date" class="block text-sm font-medium text-gray-700">Nueva Fecha y Hora *</label>
                    <input type="datetime-local" id="edit-phase-date" required class="mt-1 p-2 border border-gray-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="edit-phase-comment" class="block text-sm font-medium text-gray-700">Nota Log√≠stica/Comentario</label>
                    <textarea id="edit-phase-comment" rows="2" class="mt-1 p-2 border border-gray-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('edit-date-modal').classList.add('hidden', 'opacity-0'); document.getElementById('edit-date-modal').classList.remove('opacity-100');"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ----------------------------------------------------------------
        // Almacenamiento Local (Simulaci√≥n de Base de Datos)
        // ----------------------------------------------------------------
        const STORAGE_KEY = 'campaigns_simulator_data';
        let campaignsData = {}; 

        const loadCampaigns = () => {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                campaignsData = JSON.parse(storedData);
            }
        };

        const saveCampaigns = () => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(campaignsData));
            renderAllCampaigns();
        };

        // ----------------------------------------------------------------
        // Definici√≥n y Utiler√≠as
        // ----------------------------------------------------------------
        const PHASES = [
            'Inicio de Campa√±a',
            'Entrega de contenedores',
            'Arranque',
            '1RA Recolecci√≥n',
            '√öltima Recolecci√≥n',
            'Cierre'
        ];

        const generateId = () => 'camp-' + Date.now() + Math.random().toString(16).slice(2);

        const getPhaseDate = (campaign, phaseName) => {
            const phaseData = campaign.phases && campaign.phases[phaseName];
            if (phaseData) {
                return typeof phaseData === 'string' ? phaseData : phaseData.date;
            }
            return null;
        };

        const calculateDuration = (startDate, endDate) => {
            const start = new Date(startDate);
            const end = endDate ? new Date(endDate) : new Date();
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        };

        const pad = (n) => (n < 10 ? '0' + n : n);
        const formatDateTime = (date) => {
            return date.getUTCFullYear() +
                    pad(date.getUTCMonth() + 1) +
                    pad(date.getUTCDate()) + 'T' +
                    pad(date.getUTCHours()) +
                    pad(date.getUTCMinutes()) +
                    pad(date.getUTCSeconds()) + 'Z';
        };
        
        // ----------------------------------------------------------------
        // Funciones de Modales
        // ----------------------------------------------------------------
        window.alertModal = (title, body) => {
            const modal = document.getElementById('alert-modal');
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-body').textContent = body;
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
        };

        window.closeModal = (id) => {
            const modal = document.getElementById(id);
            modal.classList.add('hidden', 'opacity-0');
            modal.classList.remove('opacity-100');
        };

        // ----------------------------------------------------------------
        // L√≥gica Principal (CRUD Simulada)
        // ----------------------------------------------------------------

        const renderAllCampaigns = () => {
            const campaigns = Object.values(campaignsData);

            const activeCampaigns = campaigns.filter(c => c.status !== 'Cierre');
            const closedCampaigns = campaigns.filter(c => c.status === 'Cierre');

            renderCampaigns(activeCampaigns, document.getElementById('active-campaigns-list'), 'activas');
            renderCampaigns(closedCampaigns, document.getElementById('closed-campaigns-list'), 'cerradas');
        };
        
        // Agregar Campa√±a
        document.getElementById('add-campaign-form').addEventListener('submit', (e) => {
            e.preventDefault();

            const name = document.getElementById('campaign-name').value;
            const contact = document.getElementById('campaign-contact').value;
            const phone = document.getElementById('campaign-phone').value;
            const location = document.getElementById('campaign-location').value;
            const comments = document.getElementById('campaign-comments').value || 'Sin comentarios iniciales.';

            if (!name || !contact || !phone || !location) {
                alertModal("Campos Incompletos", "Por favor, complete todos los campos obligatorios.");
                return;
            }

            const initialPhase = PHASES[0]; 
            const now = new Date().toISOString();
            const id = generateId();

            const newCampaign = {
                id,
                name,
                contact,
                phone: phone.replace(/[^0-9+]/g, ''),
                location,
                comments,
                totalKilos: 0,
                status: initialPhase,
                startDate: now,
                endDate: null,
                phases: {
                    [initialPhase]: { date: now, comment: comments }
                }
            };

            campaignsData[id] = newCampaign;
            saveCampaigns(); 
            e.target.reset(); 
            alertModal("Campa√±a Agregada", `La campa√±a "${name}" ha sido iniciada en la fase: "${initialPhase}".`);
        });
        
        // Avanzar Fase
        window.advancePhase = (campaignId, currentStatus) => {
            const currentIndex = PHASES.indexOf(currentStatus);
            if (currentIndex === -1 || currentIndex === PHASES.length - 1) {
                alertModal("Estado Final", "Esta campa√±a ya ha completado todas sus fases.");
                return;
            }
            
            const nextPhase = PHASES[currentIndex + 1];
            const campaign = campaignsData[campaignId];
            
            if (currentStatus === '√öltima Recolecci√≥n') {
                openKilosModal(campaign);
                return;
            }

            openAdvanceCommentModal(campaign, nextPhase);
        };
        
        // Modal para captura de Kilos
        const openKilosModal = (campaign) => {
            const modal = document.getElementById('kilos-modal');
            document.getElementById('kilos-modal-title').textContent = `Transici√≥n a Cierre: ${campaign.name}`;
            document.getElementById('kilos-campaign-id').value = campaign.id;
            document.getElementById('kilos-next-phase').value = 'Cierre'; 
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
        };

        document.getElementById('kilos-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const campaignId = document.getElementById('kilos-campaign-id').value;
            const nextPhase = document.getElementById('kilos-next-phase').value;
            const comment = document.getElementById('campaign-kilos-comment').value || 'Campa√±a cerrada al registrar kilos.';
            const kilos = parseFloat(document.getElementById('campaign-kilos-input').value);
            const campaign = campaignsData[campaignId];

            if (isNaN(kilos) || kilos < 0) {
                alertModal("Error de Kilos", "Por favor, introduce una cantidad v√°lida y positiva de kilos.");
                return;
            }

            const now = new Date().toISOString();
            
            campaignsData[campaignId] = {
                ...campaign,
                totalKilos: kilos,
                status: nextPhase,
                endDate: now,
                phases: {
                    ...campaign.phases,
                    [nextPhase]: { date: now, comment: comment }
                }
            };

            saveCampaigns();
            closeModal('kilos-modal');
            e.target.reset();
            alertModal("Campa√±a Cerrada", `La campa√±a "${campaign.name}" ha sido cerrada con ${kilos} Kg.`);
        });

        // Modal para comentarios de avance (excepto cierre)
        const openAdvanceCommentModal = (campaign, nextPhase) => {
            const modal = document.getElementById('advance-comment-modal');
            document.getElementById('advance-comment-modal-title').textContent = `Avanzar a: ${nextPhase}`;
            document.getElementById('advance-campaign-name-display').textContent = campaign.name;
            
            document.getElementById('advance-campaign-id').value = campaign.id;
            document.getElementById('advance-next-phase').value = nextPhase;
            document.getElementById('advance-comment-input').value = ''; 
            
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
        };

        document.getElementById('advance-comment-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const campaignId = document.getElementById('advance-campaign-id').value;
            const nextPhase = document.getElementById('advance-next-phase').value;
            const comment = document.getElementById('advance-comment-input').value;

            processPhaseAdvancement(campaignId, nextPhase, comment);
        });

        window.processPhaseAdvancement = (campaignId, nextPhase, comment) => {
            const campaign = campaignsData[campaignId];
            const now = new Date().toISOString();
            
            campaignsData[campaignId] = {
                ...campaign,
                status: nextPhase,
                phases: {
                    ...campaign.phases,
                    [nextPhase]: { date: now, comment: comment || 'Sin comentarios log√≠sticos.' }
                }
            };

            saveCampaigns();
            closeModal('advance-comment-modal');
            alertModal("Fase Avanzada", `Campa√±a actualizada a la fase: "${nextPhase}" con nota.`);
        };
        
        // Funci√≥n para editar fecha
        window.openEditDateModal = (campaignId, phaseName, phaseData) => {
            const modal = document.getElementById('edit-date-modal');
            
            const currentPhaseDateISO = getPhaseDate({phases: {[phaseName]: phaseData}}, phaseName);

            let localDateTime = '';
            if (currentPhaseDateISO) {
                const d = new Date(currentPhaseDateISO);
                // Formatea la fecha y hora para el input local (YYYY-MM-DDTHH:MM)
                localDateTime = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
            }
            
            document.getElementById('edit-date-modal-title').textContent = `Editar Fecha de: ${phaseName}`;
            document.getElementById('edit-campaign-id').value = campaignId;
            document.getElementById('edit-phase-name').value = phaseName;
            document.getElementById('edit-phase-date').value = localDateTime;
            document.getElementById('edit-phase-comment').value = phaseData.comment || '';

            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
        };

        document.getElementById('edit-date-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const campaignId = document.getElementById('edit-campaign-id').value;
            const phaseName = document.getElementById('edit-phase-name').value;
            const newDateLocal = document.getElementById('edit-phase-date').value;
            const newComment = document.getElementById('edit-phase-comment').value || 'Sin comentarios log√≠sticos.';

            if (!newDateLocal) {
                alertModal("Error", "Por favor, selecciona una fecha y hora v√°lidas.");
                return;
            }
            
            const newDateISO = new Date(newDateLocal).toISOString();
            const campaign = campaignsData[campaignId];

            campaign.phases[phaseName] = { date: newDateISO, comment: newComment };
            
            if (phaseName === 'Inicio de Campa√±a') {
                campaign.startDate = newDateISO;
            }
            if (phaseName === 'Cierre') {
                campaign.endDate = newDateISO;
            }

            saveCampaigns();
            closeModal('edit-date-modal');
            alertModal("Fecha Actualizada", `La fecha y nota de la fase "${phaseName}" han sido modificadas.`);
        });

        // Modal para ver comentarios
        window.viewPhaseComment = (phaseName, comment) => {
            alertModal(`Nota de la Fase: ${phaseName}`, comment || 'No se registraron comentarios para esta fase.');
        };

        // ----------------------------------------------------------------
        // Funciones de Automatizaci√≥n (Agendar e WP)
        // ----------------------------------------------------------------
        
        window.generateIcsForPhase = (campaignJsonString, phaseName, phaseDataString) => {
            const campaign = JSON.parse(campaignJsonString);
            const phaseData = JSON.parse(phaseDataString);
            const start = new Date(phaseData.date);
            const end = new Date(start.getTime() + 60 * 60 * 1000); 
            const phaseDateDisplay = start.toLocaleDateString('es-MX');

            const description = `Campa√±a: ${campaign.name}\\nContacto: ${campaign.contact}\\nUbicaci√≥n: ${campaign.location}\\nEvento: ${phaseName}\\nNota Log√≠stica: ${phaseData.comment || 'N/A'}`;
            
            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Campaign Tracker App//NONSGML v1.0//EN',
                'BEGIN:VEVENT',
                `UID:${campaign.id}-${phaseName}-${Date.now()}`,
                `DTSTAMP:${formatDateTime(new Date())}`,
                `DTSTART:${formatDateTime(start)}`,
                `DTEND:${formatDateTime(end)}`,
                `SUMMARY:Evento de Campa√±a (${phaseName}): ${campaign.name}`,
                `LOCATION:${campaign.location}`,
                `DESCRIPTION:${description}`,
                'END:VEVENT',
                'END:VCALENDAR'
            ].join('\n');

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `${phaseName}_Campa√±a_${campaign.name.replace(/\s/g, '_')}_${phaseDateDisplay.replace(/\//g, '-')}.ics`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alertModal("Cita Agendada", `Se ha descargado el archivo .ics para el evento "${phaseName}".`);
        };

        window.sendWhatsAppMessageForPhase = (campaignJsonString, phaseName, phaseDataString) => {
            const campaign = JSON.parse(campaignJsonString);
            const phaseData = JSON.parse(phaseDataString);
            const phaseDateDisplay = new Date(phaseData.date).toLocaleDateString('es-MX');
            
            const message = `¬°Hola! Solo para confirmar que la fase *${phaseName}* de la campa√±a "${campaign.name}" fue completada exitosamente el ${phaseDateDisplay}. %0A%0ANota Log√≠stica: ${phaseData.comment || 'Sin notas.'}`;

            const phone = campaign.phone; 
            if (!phone) {
                alertModal("Error de Contacto", "El n√∫mero de contacto no est√° registrado para esta campa√±a.");
                return;
            }
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;

            window.open(whatsappUrl, '_blank');
            alertModal("Mensaje de WhatsApp", `Se ha abierto una nueva ventana para enviar el mensaje a ${phone} sobre la fase "${phaseName}".`);
        };

        window.sendWhatsAppMessageForCierre = (campaignJsonString) => {
            const campaign = JSON.parse(campaignJsonString);
            const phaseData = campaign.phases['Cierre'];
            const phaseDateDisplay = new Date(phaseData.date).toLocaleDateString('es-MX');

            const message = `¬°Campa√±a *${campaign.name}* Finalizada! %0A%0AFecha de Cierre: ${phaseDateDisplay}%0ATotal de Kilos Recolectados: ${campaign.totalKilos} Kg.%0AGracias por tu colaboraci√≥n.`;

            const phone = campaign.phone; 
            if (!phone) {
                alertModal("Error de Contacto", "El n√∫mero de contacto no est√° registrado para esta campa√±a.");
                return;
            }
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;

            window.open(whatsappUrl, '_blank');
        };

        window.generateIcsForCierre = (campaignJsonString) => {
            const campaign = JSON.parse(campaignJsonString);
            const phaseData = campaign.phases['Cierre'];
            
            const start = new Date(phaseData.date);
            const end = new Date(start.getTime() + 60 * 60 * 1000); 
            const phaseDateDisplay = start.toLocaleDateString('es-MX');

            const description = `Campa√±a: ${campaign.name}\\nTotal Kilos: ${campaign.totalKilos} Kg.\\nNota de Cierre: ${phaseData.comment || 'N/A'}`;
            
            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Campaign Tracker App//NONSGML v1.0//EN',
                'BEGIN:VEVENT',
                `UID:${campaign.id}-Cierre-${Date.now()}`,
                `DTSTAMP:${formatDateTime(new Date())}`,
                `DTSTART:${formatDateTime(start)}`,
                `DTEND:${formatDateTime(end)}`,
                `SUMMARY:Cierre de Campa√±a: ${campaign.name}`,
                `LOCATION:${campaign.location}`,
                `DESCRIPTION:${description}`,
                'END:VEVENT',
                'END:VCALENDAR'
            ].join('\n');

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `Cierre_Campa√±a_${campaign.name.replace(/\s/g, '_')}_${phaseDateDisplay.replace(/\//g, '-')}.ics`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alertModal("Cita Agendada", `Se ha descargado el archivo .ics para el cierre de la campa√±a.`);
        };

        // ----------------------------------------------------------------
        // L√≥gica de Renderizado
        // ----------------------------------------------------------------
        const renderCampaigns = (campaigns, container, type) => {
            container.innerHTML = ''; 
            
            campaigns.sort((a, b) => new Date(getPhaseDate(b, 'Inicio de Campa√±a') || b.startDate) - new Date(getPhaseDate(a, 'Inicio de Campa√±a') || a.startDate)); 

            if (campaigns.length === 0) {
                const message = type === 'activas' ? 
                    `¬°No hay campa√±as activas! Inicia una nueva campa√±a para verla aqu√≠.` :
                    `Las campa√±as cerradas aparecer√°n aqu√≠.`;
                container.innerHTML = `<p class="text-gray-500 text-center p-6 bg-white rounded-xl">${message}</p>`;
                return;
            }

            campaigns.forEach(campaign => {
                const startDateISO = getPhaseDate(campaign, 'Inicio de Campa√±a') || campaign.startDate;
                const endDateISO = getPhaseDate(campaign, 'Cierre') || campaign.endDate;
                const durationDays = calculateDuration(startDateISO, endDateISO);
                const isCompleted = campaign.status === 'Cierre';
                const currentIndex = PHASES.indexOf(campaign.status);
                const nextPhase = PHASES[currentIndex + 1];

                const efficiency = (campaign.totalKilos > 0 && durationDays > 0) ? (durationDays / campaign.totalKilos).toFixed(2) : 'N/A';
                let efficiencyText = '';
                if (isCompleted) {
                    const efficiencyValue = parseFloat(efficiency);
                    const efficiencyClass = efficiency !== 'N/A' && efficiencyValue > 0 && efficiencyValue < 0.5 ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800';
                    efficiencyText = `
                        <div class="flex flex-col items-end">
                            <span class="text-sm text-gray-700">Eficiencia (D√≠as/Kg):</span>
                            <span class="text-[0.8rem] font-bold ${efficiencyClass} rounded-md px-2 py-0.5">
                                ${efficiency}
                            </span>
                        </div>
                    `;
                }

                const campaignJsonString = JSON.stringify(campaign).replace(/"/g, '&quot;');

                const advanceButton = isCompleted ? '' : `
                    <button onclick="window.advancePhase('${campaign.id}', '${campaign.status}')" class="bg-indigo-500 text-white text-xs px-3 py-1 rounded-full hover:bg-indigo-600 transition">
                        <span class="font-bold">Avanzar a:</span> ${nextPhase}
                    </button>
                `;

                const daysStatus = isCompleted ? `Cerrada (${durationDays} D√≠as)` : `Activa (D√≠a ${durationDays})`;
                const statusColor = isCompleted ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                const totalKilosDisplay = isCompleted ? `<span class="text-lg font-bold text-green-600">${campaign.totalKilos} Kg</span>` : `<span class="text-sm text-gray-700">Total Kilos: ${campaign.totalKilos} Kg</span>`;
                const mainMetric = isCompleted ? efficiencyText : totalKilosDisplay;


                const phasesHTML = PHASES.map(phase => {
                    const isCurrent = phase === campaign.status;
                    const phaseData = campaign.phases && campaign.phases[phase]; 
                    const isDone = !!phaseData;
                    const phaseClass = isDone ? 'phase-complete' : (isCurrent ? 'phase-active' : 'bg-gray-200 text-gray-700');
                    const phaseDateISO = getPhaseDate({phases: {[phase]: phaseData}}, phase);

                    const phaseDateDisplay = isDone ? new Date(phaseDateISO).toLocaleDateString('es-MX', {day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'}) : 'Pendiente';

                    const phaseDataString = isDone ? JSON.stringify(phaseData).replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';
                    
                    const hasComment = isDone && phaseData.comment && phaseData.comment !== 'Sin comentarios iniciales.' && phaseData.comment !== 'Sin comentarios log√≠sticos.' && phaseData.comment !== 'Campa√±a cerrada al registrar kilos.';

                    const actionIcons = isDone ? `
                        <div class="flex justify-center mt-1 space-x-1">
                            <button title="Editar Fecha y Nota de ${phase}" 
                                onclick="window.openEditDateModal('${campaign.id}', '${phase}', ${JSON.stringify(phaseData).replace(/"/g, '&quot;').replace(/'/g, '&#39;')})" 
                                class="text-gray-600 hover:text-indigo-600 p-0.5 rounded-full hover:bg-gray-100 transition-colors duration-100">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3"><path d="M14.5 0l10.5 10.5-12 12-10.5-10.5 12-12zm-8 16.5l-5 5-2.5-2.5 5-5z"/></svg>
                            </button>
                            <button title="Agendar ${phase}" 
                                onclick="window.${phase === 'Cierre' ? 'generateIcsForCierre' : 'generateIcsForPhase'}('${campaignJsonString}', '${phase}', '${phaseDataString}')" 
                                class="text-blue-600 hover:text-blue-800 p-0.5 rounded-full hover:bg-gray-100 transition-colors duration-100">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3"><path d="M19 4h-1V3a1 1 0 0 0-2 0v1H8V3a1 1 0 0 0-2 0v1H5a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3zm1 15a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9h16zm-8-3h-2v-2h2zm-4 0H8v-2h2zm8 0h-2v-2h2z"/></svg>
                            </button>
                            <button title="Enviar WP ${phase}" 
                                onclick="window.${phase === 'Cierre' ? 'sendWhatsAppMessageForCierre' : 'sendWhatsAppMessageForPhase'}('${campaignJsonString}', '${phase}', '${phaseDataString}')" 
                                class="text-green-600 hover:text-green-800 p-0.5 rounded-full hover:bg-gray-100 transition-colors duration-100">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm.497 18.068l-1.071-.78c-1.222-.888-2.618-1.745-3.033-2.673-.559-1.258.46-2.584 1.884-3.791l.868-.767c.72-.638 1.442-.857 2.051-.624.512.193.896.657 1.09 1.171.194.514.072 1.087-.333 1.583-.404.496-.928.918-1.503 1.254-.575.336-1.127.424-1.574.258-.448-.166-.822-.505-1.144-.946-.322-.442-.513-.984-.572-1.564-.059-.58-.029-1.18.087-1.78.116-.6.311-1.2.587-1.8.275-.6.64-1.17 1.07-1.71.43-.54.945-1.05 1.53-1.51.586-.46 1.25-.87 1.99-1.22.74-.35 1.57-.64 2.47-.86.9-.22 1.88-.37 2.95-.39 1.07-.02 2.21.08 3.42.31 1.21.23 2.5.64 3.86 1.24 1.36.6 2.81 1.39 4.36 2.37 1.55.98 3.2 2.16 4.97 3.52 1.76 1.36 3.66 2.92 5.7 4.67 2.04 1.75 4.22 3.65 6.45 5.7.098.09.194.19.288.29.352.348.694.706 1.026 1.075.33.37.646.756.938 1.157 1.111 1.545 1.666 3.193 1.666 4.947 0 1.22-.387 2.37-1.157 3.454-.77.893-1.85 1.56-3.17 1.998-1.32.438-2.91.564-4.8.378-1.89-.186-4.06-.67-6.52-1.455-2.46-.785-5.21-1.87-8.25-3.264-3.04-1.393-6.42-3.12-10.15-5.187-3.73-2.067-7.85-4.47-12.38-7.21z"/></svg>
                            </button>
                            ${hasComment ? `
                                <button title="Ver Nota Log√≠stica" 
                                    onclick="window.viewPhaseComment('${phase}', \`${phaseData.comment}\`)" 
                                    class="text-gray-600 hover:text-yellow-600 p-0.5 rounded-full hover:bg-gray-100 transition-colors duration-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3"><path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.377-2.581 3.033-2.581h9.1c1.656 0 3.033 1.155 3.033 2.581v8.894a.75.75 0 01-.48.69l-3.344 1.486a.75.75 0 00-.472.696v.444c0 1.21.983 2.193 2.193 2.193h.38a.75.75 0 010 1.5h-.38a3.693 3.693 0 01-3.693-3.693v-.444c0-.73.468-1.373 1.153-1.639l3.344-1.486c.071-.031.117-.11.117-.193V5.653c0-.528-.431-.954-.954-.954h-9.1c-.523 0-.954.426-.954.954v1.5a.75.75 0 01-1.5 0V5.653z" clip-rule="evenodd" /></svg>
                                </button>
                            ` : ''}
                        </div>
                    ` : '';

                    let lineClass = isDone ? 'bg-green-500' : 'bg-gray-300';
                    if (isCurrent && currentIndex > 0) {
                        // Hace la l√≠nea anterior a la activa de color amarillo
                        lineClass = 'bg-yellow-500';
                    }
                    
                    const itemHTML = `
                        <div class="timeline-item text-center ${phaseClass} rounded-lg p-2" title="${isDone ? phaseDateDisplay : 'Pendiente'}">
                            <p class="text-[0.6rem] font-medium leading-tight">${phase.split(' ').map((word, i) => (i === 0 ? word.slice(0, 5) : word.slice(0, 4))).join('.')}</p>
                            <p class="text-[0.6rem] font-bold">${isDone ? new Date(phaseDateISO).toLocaleDateString('es-MX', {day: '2-digit', month: 'short'}) : 'Pendiente'}</p>
                            ${actionIcons}
                        </div>
                    `;

                    // No a√±ade l√≠nea despu√©s de la √∫ltima fase
                    const line = phase !== 'Cierre' ? `<div class="flex-grow h-0.5 ${lineClass}"></div>` : '';

                    return itemHTML + line;
                }).join('');


                const cardHTML = `
                    <div class="campaign-card bg-white p-5 rounded-xl border ${isCompleted ? 'border-green-300 opacity-90' : 'border-indigo-300'}">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">${campaign.name}</h3>
                                <p class="text-sm text-gray-500">Contacto: ${campaign.contact} | Tel: ${campaign.phone}</p>
                            </div>
                            <span class="${statusColor} text-xs font-medium px-2 py-0.5 rounded-full">
                                ${daysStatus}
                            </span>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-600 border-t pt-3 mb-4">
                            <span>Ubicaci√≥n: ${campaign.location}</span>
                            <div class="flex items-center space-x-4">
                                ${mainMetric}
                                ${advanceButton}
                            </div>
                        </div>
                        
                        <div class="timeline-item-container border-t pt-4">
                            <div class="flex justify-between items-center w-full">
                                ${phasesHTML}
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHTML;
            });
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            loadCampaigns(); 
            // Cargar campa√±as de ejemplo si no hay datos guardados
            if (Object.keys(campaignsData).length === 0) {
                 campaignsData = {
                     'camp-ejemplo-1': { id: 'camp-ejemplo-1', name: 'Piloto Ciudad Central', status: 'Arranque', contact: 'Ana L√≥pez', location: 'Centro Hist√≥rico, Col. Ju√°rez', phone: '+521234567890', totalKilos: 0, startDate: '2025-11-01T10:30:00.000Z', comments: 'Lanzamiento inicial de prueba', phases: { 'Inicio de Campa√±a': { date: '2025-11-01T10:30:00.000Z' }, 'Entrega de contenedores': { date: '2025-11-05T14:00:00.000Z' } } },
                     'camp-ejemplo-2': { id: 'camp-ejemplo-2', name: 'Prueba Beta Zona Sur', status: 'Cierre', contact: 'Roberto D√≠az', location: 'Nave Industrial 5, Zona Sur', phone: '+525555551212', totalKilos: 350, startDate: '2025-10-01T08:00:00.000Z', endDate: '2025-10-31T17:00:00.000Z', comments: 'Campa√±a completada con √©xito', phases: { 'Inicio de Campa√±a': { date: '2025-10-01T08:00:00.000Z' }, 'Entrega de contenedores': { date: '2025-10-05T10:00:00.000Z' }, 'Arranque': { date: '2025-10-10T12:00:00.000Z' }, '1RA Recolecci√≥n': { date: '2025-10-20T14:00:00.000Z' }, '√öltima Recolecci√≥n': { date: '2025-10-30T10:00:00.000Z' }, 'Cierre': { date: '2025-10-31T17:00:00.000Z', comment: 'Resultados muy favorables.' } } }
                 };
                 saveCampaigns(); // Guardar ejemplos por primera vez
            } else {
                 renderAllCampaigns();
            }
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Campa√±as - SIMULADOR 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .campaign-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .campaign-card:hover {
            transform: translateY(-2px);
        }
        .phase-complete {
            background-color: #d1fae5;
            color: #065f46;
        }
        .phase-active {
            background-color: #fffbeb;
            color: #b45309;
            font-weight: 600;
            border-left: 4px solid #f59e0b;
        }
        .timeline-item {
            position: relative;
            cursor: pointer;
            padding-top: 8px; 
            padding-bottom: 8px;
            min-width: 80px; 
            margin-right: 4px; 
        }
        .timeline-item-container {
            overflow-x: auto;
            white-space: nowrap;
        }
        /* Modal Backdrop */
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-container {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body>

    <div class="container mx-auto p-6 lg:p-12">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 mr-3 text-indigo-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
                Dashboard de Campa√±as
            </h1>
            <p id="user-id-display" class="text-sm text-gray-500 mt-1">
                ‚≠ê **Modo Simulador Activo** (Datos guardados en su navegador - LocalStorage)
            </p>
        </header>

        <div class="bg-white p-6 rounded-xl mb-8 shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">‚ûï Iniciar Nueva Campa√±a</h2>
            <form id="add-campaign-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="campaign-name" placeholder="Nombre de la Campa√±a *" required class="p-2 border border-gray-300 rounded-lg">
                <input type="text" id="campaign-contact" placeholder="Contacto Principal *" required class="p-2 border border-gray-300 rounded-lg">
                <input type="tel" id="campaign-phone" placeholder="Tel√©fono de Contacto *" required class="p-2 border border-gray-300 rounded-lg">
                <input type="text" id="campaign-location" placeholder="Ubicaci√≥n/Direcci√≥n *" required class="p-2 border border-gray-300 rounded-lg">
                <textarea id="campaign-comments" placeholder="Comentarios Iniciales (Opcional)" rows="1" class="p-2 border border-gray-300 rounded-lg md:col-span-2"></textarea>
                <button type="submit" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out md:col-span-3">
                    Crear Campa√±a
                </button>
            </form>
        </div>
        
        <hr class="my-8">

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <section>
                <h2 class="text-2xl font-semibold text-indigo-700 mb-4">üî• Campa√±as Activas</h2>
                <div id="active-campaigns-list" class="space-y-6">
                    </div>
            </section>

            <section>
                <h2 class="text-2xl font-semibold text-gray-600 mb-4">‚úÖ Campa√±as Cerradas</h2>
                <div id="closed-campaigns-list" class="space-y-6">
                    </div>
            </section>
        </div>
    </div>

    <div id="alert-modal" class="modal-backdrop fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden opacity-0 z-50"
         onclick="this.classList.add('hidden', 'opacity-0'); this.classList.remove('opacity-100');">
        <div class="modal-container bg-white rounded-lg p-6 shadow-xl w-full max-w-sm mx-4" onclick="event.stopPropagation()">
            <h3 id="alert-modal-title" class="text-lg font-bold text-gray-900 mb-3">T√≠tulo</h3>
            <p id="alert-modal-body" class="text-sm text-gray-700 mb-4">Cuerpo del mensaje.</p>
            <div class="flex justify-end">
                <button onclick="document.getElementById('alert-modal').classList.add('hidden', 'opacity-0'); document.getElementById('alert-modal').classList.remove('opacity-100');"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700 transition">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="kilos-modal" class="modal-backdrop fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden opacity-0 z-50">
        <div class="modal-container bg-white rounded-lg p-6 shadow-xl w-full max-w-md mx-4" onclick="event.stopPropagation()">
            <h3 id="kilos-modal-title" class="text-xl font-bold text-gray-900 mb-4">Transici√≥n a Cierre: [Nombre Campa√±a]</h3>
            <form id="kilos-form">
                <input type="hidden" id="kilos-campaign-id">
                <input type="hidden" id="kilos-next-phase">
                <div class="mb-4">
                    <label for="campaign-kilos-input" class="block text-sm font-medium text-gray-700">Total de Kilos Recolectados *</label>
                    <input type="number" step="0.01" min="0" id="campaign-kilos-input" required class="mt-1 p-2 border border-gray-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="campaign-kilos-comment" class="block text-sm font-medium text-gray-700">Nota de Cierre (Opcional)</label>
                    <textarea id="campaign-kilos-comment" rows="2" class="mt-1 p-2 border border-gray-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('kilos-modal').classList.add('hidden', 'opacity-0'); document.getElementById('kilos-modal').classList.remove('opacity-100');"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">Cancelar</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition">
                        Cerrar Campa√±a
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="advance-comment-modal" class="modal-backdrop fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden opacity-0 z-50">
        <div class="modal-container bg-white rounded-lg p-6 shadow-xl w-full max-w-md mx-4" onclick="event.stopPropagation()">
            <h3 id="advance-comment-modal-title" class="text-xl font-bold text-gray-900 mb-2">Avanzar a: [Fase]</h3>
            <p class="text-sm text-gray-500 mb-4">Campa√±a: <span id="advance-campaign-name-display" class="font-medium text-indigo-600"></span></p>
            <form id="advance-comment-form">
                <input type="hidden" id="advance-campaign-id">
                <input type="hidden" id="advance-next-phase">
                <div class="mb-6">
                    <label for="advance-comment-input" class="block text-sm font-medium text-gray-700">Nota Log√≠stica/Comentario (Opcional)</label>
                    <textarea id="advance-comment-input" rows="3" placeholder="Ej: Contenedores entregados sin problema. El arranque ser√° el lunes." class="mt-1 p-2 border border-gray-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('advance-comment-modal').classList.add('hidden', 'opacity-0'); document.getElementById('advance-comment-modal').classList.remove('opacity-100');"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition">
                        Confirmar Avance
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-date-modal" class="modal-backdrop fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden opacity-0 z-50">
        <div class="modal-container bg-white rounded-lg p-6 shadow-xl w-full max-w-md mx-4" onclick="event.stopPropagation()">
            <h3 id="edit-date-modal-title" class="text-xl font-bold text-gray-900 mb-4">Editar Fecha de: [Fase]</h3>
            <form id="edit-date-form">
                <input type="hidden" id="edit-campaign-id">
                <input type="hidden" id="edit-phase-name">
                <div class="mb-4">
                    <label for="edit-phase-date" class="block text-sm font-medium text-gray-700">Nueva Fecha y Hora *</label>
                    <input type="datetime-local" id="edit-phase-date" required class="mt-1 p-2 border border-gray-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="edit-phase-comment" class="block text-sm font-medium text-gray-700">Nota Log√≠stica/Comentario</label>
                    <textarea id="edit-phase-comment" rows="2" class="mt-1 p-2 border border-gray-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('edit-date-modal').classList.add('hidden', 'opacity-0'); document.getElementById('edit-date-modal').classList.remove('opacity-100');"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ----------------------------------------------------------------
        // Almacenamiento Local (Simulaci√≥n de Base de Datos)
        // ----------------------------------------------------------------
        const STORAGE_KEY = 'campaigns_simulator_data';
        let campaignsData = {}; 

        const loadCampaigns = () => {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                campaignsData = JSON.parse(storedData);
            }
        };

        const saveCampaigns = () => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(campaignsData));
            renderAllCampaigns();
        };

        // ----------------------------------------------------------------
        // Definici√≥n y Utiler√≠as
        // ----------------------------------------------------------------
        const PHASES = [
            'Inicio de Campa√±a',
            'Entrega de contenedores',
            'Arranque',
            '1RA Recolecci√≥n',
            '√öltima Recolecci√≥n',
            'Cierre'
        ];

        const generateId = () => 'camp-' + Date.now() + Math.random().toString(16).slice(2);

        const getPhaseDate = (campaign, phaseName) => {
            const phaseData = campaign.phases && campaign.phases[phaseName];
            if (phaseData) {
                return typeof phaseData === 'string' ? phaseData : phaseData.date;
            }
            return null;
        };

        const calculateDuration = (startDate, endDate) => {
            const start = new Date(startDate);
            const end = endDate ? new Date(endDate) : new Date();
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        };

        const pad = (n) => (n < 10 ? '0' + n : n);
        const formatDateTime = (date) => {
            return date.getUTCFullYear() +
                    pad(date.getUTCMonth() + 1) +
                    pad(date.getUTCDate()) + 'T' +
                    pad(date.getUTCHours()) +
                    pad(date.getUTCMinutes()) +
                    pad(date.getUTCSeconds()) + 'Z';
        };
        
        // ----------------------------------------------------------------
        // Funciones de Modales
        // ----------------------------------------------------------------
        window.alertModal = (title, body) => {
            const modal = document.getElementById('alert-modal');
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-body').textContent = body;
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
        };

        window.closeModal = (id) => {
            const modal = document.getElementById(id);
            modal.classList.add('hidden', 'opacity-0');
            modal.classList.remove('opacity-100');
        };

        // ----------------------------------------------------------------
        // L√≥gica Principal (CRUD Simulada)
        // ----------------------------------------------------------------

        const renderAllCampaigns = () => {
            const campaigns = Object.values(campaignsData);

            const activeCampaigns = campaigns.filter(c => c.status !== 'Cierre');
            const closedCampaigns = campaigns.filter(c => c.status === 'Cierre');

            renderCampaigns(activeCampaigns, document.getElementById('active-campaigns-list'), 'activas');
            renderCampaigns(closedCampaigns, document.getElementById('closed-campaigns-list'), 'cerradas');
        };
        
        // Agregar Campa√±a
        document.getElementById('add-campaign-form').addEventListener('submit', (e) => {
            e.preventDefault();

            const name = document.getElementById('campaign-name').value;
            const contact = document.getElementById('campaign-contact').value;
            const phone = document.getElementById('campaign-phone').value;
            const location = document.getElementById('campaign-location').value;
            const comments = document.getElementById('campaign-comments').value || 'Sin comentarios iniciales.';

            if (!name || !contact || !phone || !location) {
                alertModal("Campos Incompletos", "Por favor, complete todos los campos obligatorios.");
                return;
            }

            const initialPhase = PHASES[0]; 
            const now = new Date().toISOString();
            const id = generateId();

            const newCampaign = {
                id,
                name,
                contact,
                phone: phone.replace(/[^0-9+]/g, ''),
                location,
                comments,
                totalKilos: 0,
                status: initialPhase,
                startDate: now,
                endDate: null,
                phases: {
                    [initialPhase]: { date: now, comment: comments }
                }
            };

            campaignsData[id] = newCampaign;
            saveCampaigns(); 
            e.target.reset(); 
            alertModal("Campa√±a Agregada", `La campa√±a "${name}" ha sido iniciada en la fase: "${initialPhase}".`);
        });
        
        // Avanzar Fase
        window.advancePhase = (campaignId, currentStatus) => {
            const currentIndex = PHASES.indexOf(currentStatus);
            if (currentIndex === -1 || currentIndex === PHASES.length - 1) {
                alertModal("Estado Final", "Esta campa√±a ya ha completado todas sus fases.");
                return;
            }
            
            const nextPhase = PHASES[currentIndex + 1];
            const campaign = campaignsData[campaignId];
            
            if (currentStatus === '√öltima Recolecci√≥n') {
                openKilosModal(campaign);
                return;
            }

            openAdvanceCommentModal(campaign, nextPhase);
        };
        
        // Modal para captura de Kilos
        const openKilosModal = (campaign) => {
            const modal = document.getElementById('kilos-modal');
            document.getElementById('kilos-modal-title').textContent = `Transici√≥n a Cierre: ${campaign.name}`;
            document.getElementById('kilos-campaign-id').value = campaign.id;
            document.getElementById('kilos-next-phase').value = 'Cierre'; 
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
        };

        document.getElementById('kilos-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const campaignId = document.getElementById('kilos-campaign-id').value;
            const nextPhase = document.getElementById('kilos-next-phase').value;
            const comment = document.getElementById('campaign-kilos-comment').value || 'Campa√±a cerrada al registrar kilos.';
            const kilos = parseFloat(document.getElementById('campaign-kilos-input').value);
            const campaign = campaignsData[campaignId];

            if (isNaN(kilos) || kilos < 0) {
                alertModal("Error de Kilos", "Por favor, introduce una cantidad v√°lida y positiva de kilos.");
                return;
            }

            const now = new Date().toISOString();
            
            campaignsData[campaignId] = {
                ...campaign,
                totalKilos: kilos,
                status: nextPhase,
                endDate: now,
                phases: {
                    ...campaign.phases,
                    [nextPhase]: { date: now, comment: comment }
                }
            };

            saveCampaigns();
            closeModal('kilos-modal');
            e.target.reset();
            alertModal("Campa√±a Cerrada", `La campa√±a "${campaign.name}" ha sido cerrada con ${kilos} Kg.`);
        });

        // Modal para comentarios de avance (excepto cierre)
        const openAdvanceCommentModal = (campaign, nextPhase) => {
            const modal = document.getElementById('advance-comment-modal');
            document.getElementById('advance-comment-modal-title').textContent = `Avanzar a: ${nextPhase}`;
            document.getElementById('advance-campaign-name-display').textContent = campaign.name;
            
            document.getElementById('advance-campaign-id').value = campaign.id;
            document.getElementById('advance-next-phase').value = nextPhase;
            document.getElementById('advance-comment-input').value = ''; 
            
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
        };

        document.getElementById('advance-comment-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const campaignId = document.getElementById('advance-campaign-id').value;
            const nextPhase = document.getElementById('advance-next-phase').value;
            const comment = document.getElementById('advance-comment-input').value;

            processPhaseAdvancement(campaignId, nextPhase, comment);
        });

        window.processPhaseAdvancement = (campaignId, nextPhase, comment) => {
            const campaign = campaignsData[campaignId];
            const now = new Date().toISOString();
            
            campaignsData[campaignId] = {
                ...campaign,
                status: nextPhase,
                phases: {
                    ...campaign.phases,
                    [nextPhase]: { date: now, comment: comment || 'Sin comentarios log√≠sticos.' }
                }
            };

            saveCampaigns();
            closeModal('advance-comment-modal');
            alertModal("Fase Avanzada", `Campa√±a actualizada a la fase: "${nextPhase}" con nota.`);
        };
        
        // Funci√≥n para editar fecha
        window.openEditDateModal = (campaignId, phaseName, phaseData) => {
            const modal = document.getElementById('edit-date-modal');
            
            const currentPhaseDateISO = getPhaseDate({phases: {[phaseName]: phaseData}}, phaseName);

            let localDateTime = '';
            if (currentPhaseDateISO) {
                const d = new Date(currentPhaseDateISO);
                // Formatea la fecha y hora para el input local (YYYY-MM-DDTHH:MM)
                localDateTime = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
            }
            
            document.getElementById('edit-date-modal-title').textContent = `Editar Fecha de: ${phaseName}`;
            document.getElementById('edit-campaign-id').value = campaignId;
            document.getElementById('edit-phase-name').value = phaseName;
            document.getElementById('edit-phase-date').value = localDateTime;
            document.getElementById('edit-phase-comment').value = phaseData.comment || '';

            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
        };

        document.getElementById('edit-date-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const campaignId = document.getElementById('edit-campaign-id').value;
            const phaseName = document.getElementById('edit-phase-name').value;
            const newDateLocal = document.getElementById('edit-phase-date').value;
            const newComment = document.getElementById('edit-phase-comment').value || 'Sin comentarios log√≠sticos.';

            if (!newDateLocal) {
                alertModal("Error", "Por favor, selecciona una fecha y hora v√°lidas.");
                return;
            }
            
            const newDateISO = new Date(newDateLocal).toISOString();
            const campaign = campaignsData[campaignId];

            campaign.phases[phaseName] = { date: newDateISO, comment: newComment };
            
            if (phaseName === 'Inicio de Campa√±a') {
                campaign.startDate = newDateISO;
            }
            if (phaseName === 'Cierre') {
                campaign.endDate = newDateISO;
            }

            saveCampaigns();
            closeModal('edit-date-modal');
            alertModal("Fecha Actualizada", `La fecha y nota de la fase "${phaseName}" han sido modificadas.`);
        });

        // Modal para ver comentarios
        window.viewPhaseComment = (phaseName, comment) => {
            alertModal(`Nota de la Fase: ${phaseName}`, comment || 'No se registraron comentarios para esta fase.');
        };

        // ----------------------------------------------------------------
        // Funciones de Automatizaci√≥n (Agendar e WP)
        // ----------------------------------------------------------------
        
        window.generateIcsForPhase = (campaignJsonString, phaseName, phaseDataString) => {
            const campaign = JSON.parse(campaignJsonString);
            const phaseData = JSON.parse(phaseDataString);
            const start = new Date(phaseData.date);
            const end = new Date(start.getTime() + 60 * 60 * 1000); 
            const phaseDateDisplay = start.toLocaleDateString('es-MX');

            const description = `Campa√±a: ${campaign.name}\\nContacto: ${campaign.contact}\\nUbicaci√≥n: ${campaign.location}\\nEvento: ${phaseName}\\nNota Log√≠stica: ${phaseData.comment || 'N/A'}`;
            
            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Campaign Tracker App//NONSGML v1.0//EN',
                'BEGIN:VEVENT',
                `UID:${campaign.id}-${phaseName}-${Date.now()}`,
                `DTSTAMP:${formatDateTime(new Date())}`,
                `DTSTART:${formatDateTime(start)}`,
                `DTEND:${formatDateTime(end)}`,
                `SUMMARY:Evento de Campa√±a (${phaseName}): ${campaign.name}`,
                `LOCATION:${campaign.location}`,
                `DESCRIPTION:${description}`,
                'END:VEVENT',
                'END:VCALENDAR'
            ].join('\n');

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `${phaseName}_Campa√±a_${campaign.name.replace(/\s/g, '_')}_${phaseDateDisplay.replace(/\//g, '-')}.ics`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alertModal("Cita Agendada", `Se ha descargado el archivo .ics para el evento "${phaseName}".`);
        };

        window.sendWhatsAppMessageForPhase = (campaignJsonString, phaseName, phaseDataString) => {
            const campaign = JSON.parse(campaignJsonString);
            const phaseData = JSON.parse(phaseDataString);
            const phaseDateDisplay = new Date(phaseData.date).toLocaleDateString('es-MX');
            
            const message = `¬°Hola! Solo para confirmar que la fase *${phaseName}* de la campa√±a "${campaign.name}" fue completada exitosamente el ${phaseDateDisplay}. %0A%0ANota Log√≠stica: ${phaseData.comment || 'Sin notas.'}`;

            const phone = campaign.phone; 
            if (!phone) {
                alertModal("Error de Contacto", "El n√∫mero de contacto no est√° registrado para esta campa√±a.");
                return;
            }
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;

            window.open(whatsappUrl, '_blank');
            alertModal("Mensaje de WhatsApp", `Se ha abierto una nueva ventana para enviar el mensaje a ${phone} sobre la fase "${phaseName}".`);
        };

        window.sendWhatsAppMessageForCierre = (campaignJsonString) => {
            const campaign = JSON.parse(campaignJsonString);
            const phaseData = campaign.phases['Cierre'];
            const phaseDateDisplay = new Date(phaseData.date).toLocaleDateString('es-MX');

            const message = `¬°Campa√±a *${campaign.name}* Finalizada! %0A%0AFecha de Cierre: ${phaseDateDisplay}%0ATotal de Kilos Recolectados: ${campaign.totalKilos} Kg.%0AGracias por tu colaboraci√≥n.`;

            const phone = campaign.phone; 
            if (!phone) {
                alertModal("Error de Contacto", "El n√∫mero de contacto no est√° registrado para esta campa√±a.");
                return;
            }
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;

            window.open(whatsappUrl, '_blank');
        };

        window.generateIcsForCierre = (campaignJsonString) => {
            const campaign = JSON.parse(campaignJsonString);
            const phaseData = campaign.phases['Cierre'];
            
            const start = new Date(phaseData.date);
            const end = new Date(start.getTime() + 60 * 60 * 1000); 
            const phaseDateDisplay = start.toLocaleDateString('es-MX');

            const description = `Campa√±a: ${campaign.name}\\nTotal Kilos: ${campaign.totalKilos} Kg.\\nNota de Cierre: ${phaseData.comment || 'N/A'}`;
            
            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Campaign Tracker App//NONSGML v1.0//EN',
                'BEGIN:VEVENT',
                `UID:${campaign.id}-Cierre-${Date.now()}`,
                `DTSTAMP:${formatDateTime(new Date())}`,
                `DTSTART:${formatDateTime(start)}`,
                `DTEND:${formatDateTime(end)}`,
                `SUMMARY:Cierre de Campa√±a: ${campaign.name}`,
                `LOCATION:${campaign.location}`,
                `DESCRIPTION:${description}`,
                'END:VEVENT',
                'END:VCALENDAR'
            ].join('\n');

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `Cierre_Campa√±a_${campaign.name.replace(/\s/g, '_')}_${phaseDateDisplay.replace(/\//g, '-')}.ics`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alertModal("Cita Agendada", `Se ha descargado el archivo .ics para el cierre de la campa√±a.`);
        };

        // ----------------------------------------------------------------
        // L√≥gica de Renderizado
        // ----------------------------------------------------------------
        const renderCampaigns = (campaigns, container, type) => {
            container.innerHTML = ''; 
            
            campaigns.sort((a, b) => new Date(getPhaseDate(b, 'Inicio de Campa√±a') || b.startDate) - new Date(getPhaseDate(a, 'Inicio de Campa√±a') || a.startDate)); 

            if (campaigns.length === 0) {
                const message = type === 'activas' ? 
                    `¬°No hay campa√±as activas! Inicia una nueva campa√±a para verla aqu√≠.` :
                    `Las campa√±as cerradas aparecer√°n aqu√≠.`;
                container.innerHTML = `<p class="text-gray-500 text-center p-6 bg-white rounded-xl">${message}</p>`;
                return;
            }

            campaigns.forEach(campaign => {
                const startDateISO = getPhaseDate(campaign, 'Inicio de Campa√±a') || campaign.startDate;
                const endDateISO = getPhaseDate(campaign, 'Cierre') || campaign.endDate;
                const durationDays = calculateDuration(startDateISO, endDateISO);
                const isCompleted = campaign.status === 'Cierre';
                const currentIndex = PHASES.indexOf(campaign.status);
                const nextPhase = PHASES[currentIndex + 1];

                const efficiency = (campaign.totalKilos > 0 && durationDays > 0) ? (durationDays / campaign.totalKilos).toFixed(2) : 'N/A';
                let efficiencyText = '';
                if (isCompleted) {
                    const efficiencyValue = parseFloat(efficiency);
                    const efficiencyClass = efficiency !== 'N/A' && efficiencyValue > 0 && efficiencyValue < 0.5 ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800';
                    efficiencyText = `
                        <div class="flex flex-col items-end">
                            <span class="text-sm text-gray-700">Eficiencia (D√≠as/Kg):</span>
                            <span class="text-[0.8rem] font-bold ${efficiencyClass} rounded-md px-2 py-0.5">
                                ${efficiency}
                            </span>
                        </div>
                    `;
                }

                const campaignJsonString = JSON.stringify(campaign).replace(/"/g, '&quot;');

                const advanceButton = isCompleted ? '' : `
                    <button onclick="window.advancePhase('${campaign.id}', '${campaign.status}')" class="bg-indigo-500 text-white text-xs px-3 py-1 rounded-full hover:bg-indigo-600 transition">
                        <span class="font-bold">Avanzar a:</span> ${nextPhase}
                    </button>
                `;

                const daysStatus = isCompleted ? `Cerrada (${durationDays} D√≠as)` : `Activa (D√≠a ${durationDays})`;
                const statusColor = isCompleted ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                const totalKilosDisplay = isCompleted ? `<span class="text-lg font-bold text-green-600">${campaign.totalKilos} Kg</span>` : `<span class="text-sm text-gray-700">Total Kilos: ${campaign.totalKilos} Kg</span>`;
                const mainMetric = isCompleted ? efficiencyText : totalKilosDisplay;


                const phasesHTML = PHASES.map(phase => {
                    const isCurrent = phase === campaign.status;
                    const phaseData = campaign.phases && campaign.phases[phase]; 
                    const isDone = !!phaseData;
                    const phaseClass = isDone ? 'phase-complete' : (isCurrent ? 'phase-active' : 'bg-gray-200 text-gray-700');
                    const phaseDateISO = getPhaseDate({phases: {[phase]: phaseData}}, phase);

                    const phaseDateDisplay = isDone ? new Date(phaseDateISO).toLocaleDateString('es-MX', {day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'}) : 'Pendiente';

                    const phaseDataString = isDone ? JSON.stringify(phaseData).replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';
                    
                    const hasComment = isDone && phaseData.comment && phaseData.comment !== 'Sin comentarios iniciales.' && phaseData.comment !== 'Sin comentarios log√≠sticos.' && phaseData.comment !== 'Campa√±a cerrada al registrar kilos.';

                    const actionIcons = isDone ? `
                        <div class="flex justify-center mt-1 space-x-1">
                            <button title="Editar Fecha y Nota de ${phase}" 
                                onclick="window.openEditDateModal('${campaign.id}', '${phase}', ${JSON.stringify(phaseData).replace(/"/g, '&quot;').replace(/'/g, '&#39;')})" 
                                class="text-gray-600 hover:text-indigo-600 p-0.5 rounded-full hover:bg-gray-100 transition-colors duration-100">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3"><path d="M14.5 0l10.5 10.5-12 12-10.5-10.5 12-12zm-8 16.5l-5 5-2.5-2.5 5-5z"/></svg>
                            </button>
                            <button title="Agendar ${phase}" 
                                onclick="window.${phase === 'Cierre' ? 'generateIcsForCierre' : 'generateIcsForPhase'}('${campaignJsonString}', '${phase}', '${phaseDataString}')" 
                                class="text-blue-600 hover:text-blue-800 p-0.5 rounded-full hover:bg-gray-100 transition-colors duration-100">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3"><path d="M19 4h-1V3a1 1 0 0 0-2 0v1H8V3a1 1 0 0 0-2 0v1H5a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3zm1 15a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9h16zm-8-3h-2v-2h2zm-4 0H8v-2h2zm8 0h-2v-2h2z"/></svg>
                            </button>
                            <button title="Enviar WP ${phase}" 
                                onclick="window.${phase === 'Cierre' ? 'sendWhatsAppMessageForCierre' : 'sendWhatsAppMessageForPhase'}('${campaignJsonString}', '${phase}', '${phaseDataString}')" 
                                class="text-green-600 hover:text-green-800 p-0.5 rounded-full hover:bg-gray-100 transition-colors duration-100">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm.497 18.068l-1.071-.78c-1.222-.888-2.618-1.745-3.033-2.673-.559-1.258.46-2.584 1.884-3.791l.868-.767c.72-.638 1.442-.857 2.051-.624.512.193.896.657 1.09 1.171.194.514.072 1.087-.333 1.583-.404.496-.928.918-1.503 1.254-.575.336-1.127.424-1.574.258-.448-.166-.822-.505-1.144-.946-.322-.442-.513-.984-.572-1.564-.059-.58-.029-1.18.087-1.78.116-.6.311-1.2.587-1.8.275-.6.64-1.17 1.07-1.71.43-.54.945-1.05 1.53-1.51.586-.46 1.25-.87 1.99-1.22.74-.35 1.57-.64 2.47-.86.9-.22 1.88-.37 2.95-.39 1.07-.02 2.21.08 3.42.31 1.21.23 2.5.64 3.86 1.24 1.36.6 2.81 1.39 4.36 2.37 1.55.98 3.2 2.16 4.97 3.52 1.76 1.36 3.66 2.92 5.7 4.67 2.04 1.75 4.22 3.65 6.45 5.7.098.09.194.19.288.29.352.348.694.706 1.026 1.075.33.37.646.756.938 1.157 1.111 1.545 1.666 3.193 1.666 4.947 0 1.22-.387 2.37-1.157 3.454-.77.893-1.85 1.56-3.17 1.998-1.32.438-2.91.564-4.8.378-1.89-.186-4.06-.67-6.52-1.455-2.46-.785-5.21-1.87-8.25-3.264-3.04-1.393-6.42-3.12-10.15-5.187-3.73-2.067-7.85-4.47-12.38-7.21z"/></svg>
                            </button>
                            ${hasComment ? `
                                <button title="Ver Nota Log√≠stica" 
                                    onclick="window.viewPhaseComment('${phase}', \`${phaseData.comment}\`)" 
                                    class="text-gray-600 hover:text-yellow-600 p-0.5 rounded-full hover:bg-gray-100 transition-colors duration-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3"><path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.377-2.581 3.033-2.581h9.1c1.656 0 3.033 1.155 3.033 2.581v8.894a.75.75 0 01-.48.69l-3.344 1.486a.75.75 0 00-.472.696v.444c0 1.21.983 2.193 2.193 2.193h.38a.75.75 0 010 1.5h-.38a3.693 3.693 0 01-3.693-3.693v-.444c0-.73.468-1.373 1.153-1.639l3.344-1.486c.071-.031.117-.11.117-.193V5.653c0-.528-.431-.954-.954-.954h-9.1c-.523 0-.954.426-.954.954v1.5a.75.75 0 01-1.5 0V5.653z" clip-rule="evenodd" /></svg>
                                </button>
                            ` : ''}
                        </div>
                    ` : '';

                    let lineClass = isDone ? 'bg-green-500' : 'bg-gray-300';
                    if (isCurrent && currentIndex > 0) {
                        // Hace la l√≠nea anterior a la activa de color amarillo
                        lineClass = 'bg-yellow-500';
                    }
                    
                    const itemHTML = `
                        <div class="timeline-item text-center ${phaseClass} rounded-lg p-2" title="${isDone ? phaseDateDisplay : 'Pendiente'}">
                            <p class="text-[0.6rem] font-medium leading-tight">${phase.split(' ').map((word, i) => (i === 0 ? word.slice(0, 5) : word.slice(0, 4))).join('.')}</p>
                            <p class="text-[0.6rem] font-bold">${isDone ? new Date(phaseDateISO).toLocaleDateString('es-MX', {day: '2-digit', month: 'short'}) : 'Pendiente'}</p>
                            ${actionIcons}
                        </div>
                    `;

                    // No a√±ade l√≠nea despu√©s de la √∫ltima fase
                    const line = phase !== 'Cierre' ? `<div class="flex-grow h-0.5 ${lineClass}"></div>` : '';

                    return itemHTML + line;
                }).join('');


                const cardHTML = `
                    <div class="campaign-card bg-white p-5 rounded-xl border ${isCompleted ? 'border-green-300 opacity-90' : 'border-indigo-300'}">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">${campaign.name}</h3>
                                <p class="text-sm text-gray-500">Contacto: ${campaign.contact} | Tel: ${campaign.phone}</p>
                            </div>
                            <span class="${statusColor} text-xs font-medium px-2 py-0.5 rounded-full">
                                ${daysStatus}
                            </span>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-600 border-t pt-3 mb-4">
                            <span>Ubicaci√≥n: ${campaign.location}</span>
                            <div class="flex items-center space-x-4">
                                ${mainMetric}
                                ${advanceButton}
                            </div>
                        </div>
                        
                        <div class="timeline-item-container border-t pt-4">
                            <div class="flex justify-between items-center w-full">
                                ${phasesHTML}
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHTML;
            });
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            loadCampaigns(); 
            // Cargar campa√±as de ejemplo si no hay datos guardados
            if (Object.keys(campaignsData).length === 0) {
                 campaignsData = {
                     'camp-ejemplo-1': { id: 'camp-ejemplo-1', name: 'Piloto Ciudad Central', status: 'Arranque', contact: 'Ana L√≥pez', location: 'Centro Hist√≥rico, Col. Ju√°rez', phone: '+521234567890', totalKilos: 0, startDate: '2025-11-01T10:30:00.000Z', comments: 'Lanzamiento inicial de prueba', phases: { 'Inicio de Campa√±a': { date: '2025-11-01T10:30:00.000Z' }, 'Entrega de contenedores': { date: '2025-11-05T14:00:00.000Z' } } },
                     'camp-ejemplo-2': { id: 'camp-ejemplo-2', name: 'Prueba Beta Zona Sur', status: 'Cierre', contact: 'Roberto D√≠az', location: 'Nave Industrial 5, Zona Sur', phone: '+525555551212', totalKilos: 350, startDate: '2025-10-01T08:00:00.000Z', endDate: '2025-10-31T17:00:00.000Z', comments: 'Campa√±a completada con √©xito', phases: { 'Inicio de Campa√±a': { date: '2025-10-01T08:00:00.000Z' }, 'Entrega de contenedores': { date: '2025-10-05T10:00:00.000Z' }, 'Arranque': { date: '2025-10-10T12:00:00.000Z' }, '1RA Recolecci√≥n': { date: '2025-10-20T14:00:00.000Z' }, '√öltima Recolecci√≥n': { date: '2025-10-30T10:00:00.000Z' }, 'Cierre': { date: '2025-10-31T17:00:00.000Z', comment: 'Resultados muy favorables.' } } }
                 };
                 saveCampaigns(); // Guardar ejemplos por primera vez
            } else {
                 renderAllCampaigns();
            }
        });
    </script>
</body>
</html>
