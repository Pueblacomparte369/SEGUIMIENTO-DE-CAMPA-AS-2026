<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Campañas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .campaign-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .campaign-card:hover {
            transform: translateY(-2px);
        }
        .phase-complete {
            background-color: #d1fae5;
            color: #065f46;
        }
        .phase-active {
            background-color: #fffbeb;
            color: #b45309;
            font-weight: 600;
            border-left: 4px solid #f59e0b;
        }
        .timeline-item {
            position: relative;
            cursor: pointer;
            padding-top: 8px; 
            padding-bottom: 8px;
            min-width: 80px; 
            margin-right: 4px; 
        }
        .timeline-item-container {
            overflow-x: auto;
            white-space: nowrap;
        }
    </style>
</head>
<body>

    <!-- Scripts de Firebase y Lógica -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');
        
        let app, db, auth, userId = null;
        let campaignsData = {}; 

        try {
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' && __firebase_config ? __firebase_config : '{}');
            
            if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                throw new Error("La configuración de Firebase es inválida o está vacía.");
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-campaign-tracker-app';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            console.log("Firebase Config cargada con éxito.");

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            const authenticate = async () => {
                try {
                    await setPersistence(auth, browserSessionPersistence);

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Autenticación exitosa con token personalizado.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Autenticación anónima exitosa.");
                    }
                } catch (error) {
                    console.error("Error durante la autenticación:", error);
                }
            };

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = `ID de Usuario: ${userId}`;
                    initializeCampaignsListener();
                } else {
                    authenticate();
                }
            });

            // ----------------------------------------------------------------
            // Definición y Utilerías
            // ----------------------------------------------------------------
            const PHASES = [
                'Inicio de Campaña',
                'Entrega de contenedores',
                'Arranque',
                '1RA Recolección',
                'Última Recolección',
                'Cierre'
            ];

            const getCampaignsCollectionRef = (uid) => {
                if (!appId || !uid) {
                    console.error("Error: App ID o User ID no definido para la colección.");
                    return null;
                }
                return collection(db, 'artifacts', appId, 'users', uid, 'campaigns');
            };

            // Función para obtener la fecha ISO desde el objeto de fase
            const getPhaseDate = (campaign, phaseName) => {
                const phaseData = campaign.phases && campaign.phases[phaseName];
                if (phaseData) {
                    return typeof phaseData === 'string' ? phaseData : phaseData.date;
                }
                return null;
            };

            const calculateDuration = (startDate, endDate) => {
                const start = new Date(startDate);
                const end = endDate ? new Date(endDate) : new Date();
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            };

            const pad = (n) => (n < 10 ? '0' + n : n);
            const formatDateTime = (date) => {
                // Formatea a UTC para ICS
                return date.getUTCFullYear() +
                        pad(date.getUTCMonth() + 1) +
                        pad(date.getUTCDate()) + 'T' +
                        pad(date.getUTCHours()) +
                        pad(date.getUTCMinutes()) +
                        pad(date.getUTCSeconds()) + 'Z';
            };


            // ----------------------------------------------------------------
            // Lógica Principal (CRUD)
            // ----------------------------------------------------------------

            const initializeCampaignsListener = () => {
                if (!userId) return; 

                const campaignsRef = getCampaignsCollectionRef(userId);
                if (!campaignsRef) return; 
                
                onSnapshot(campaignsRef, (snapshot) => {
                    campaignsData = {};
                    const campaigns = snapshot.docs.map(doc => {
                        const data = { id: doc.id, ...doc.data() };
                        campaignsData[doc.id] = data;
                        return data;
                    });

                    const activeCampaigns = campaigns.filter(c => c.status !== 'Cierre');
                    const closedCampaigns = campaigns.filter(c => c.status === 'Cierre');

                    renderCampaigns(activeCampaigns, document.getElementById('active-campaigns-list'), 'activas');
                    renderCampaigns(closedCampaigns, document.getElementById('closed-campaigns-list'), 'cerradas');

                }, (error) => {
                    console.error("Error al obtener campañas en tiempo real (onSnapshot):", error);
                });
            };

            document.getElementById('add-campaign-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!userId) {
                    alertModal("Error: Usuario no autenticado.", "Por favor, espere a que la autenticación se complete.");
                    return;
                }
                
                const campaignsRef = getCampaignsCollectionRef(userId);
                if (!campaignsRef) return;

                const name = document.getElementById('campaign-name').value;
                const contact = document.getElementById('campaign-contact').value;
                const phone = document.getElementById('campaign-phone').value;
                const location = document.getElementById('campaign-location').value;
                const comments = document.getElementById('campaign-comments').value || 'Sin comentarios iniciales.';

                
                if (!name || !contact || !phone || !location) {
                    alertModal("Campos Incompletos", "Por favor, complete todos los campos obligatorios.");
                    return;
                }

                const initialPhase = PHASES[0]; // 'Inicio de Campaña'
                const now = new Date().toISOString();

                const newCampaign = {
                    name,
                    contact,
                    phone: phone.replace(/[^0-9+]/g, ''),
                    location,
                    comments,
                    totalKilos: 0,
                    status: initialPhase,
                    startDate: now,
                    endDate: null,
                    phases: {
                        [initialPhase]: { date: now, comment: comments } // Nueva estructura de fase
                    }
                };

                try {
                    await addDoc(campaignsRef, newCampaign);
                    e.target.reset(); 
                    alertModal("Campaña Agregada", `La campaña "${name}" ha sido iniciada en la fase: "${initialPhase}".`);
                } catch (error) {
                    console.error("Error al agregar documento:", error);
                    alertModal("Error", "No se pudo guardar la campaña.");
                }
            });

            // Función principal que abre el modal de avance y comentario
            window.advancePhase = (campaignId, currentStatus) => {
                if (!userId) {
                    alertModal("Error: Usuario no autenticado.", "Por favor, espere a que la autenticación se complete.");
                    return;
                }

                const currentIndex = PHASES.indexOf(currentStatus);
                if (currentIndex === -1 || currentIndex === PHASES.length - 1) {
                    alertModal("Estado Final", "Esta campaña ya ha completado todas sus fases.");
                    return;
                }
                
                const nextPhase = PHASES[currentIndex + 1];
                const campaign = campaignsData[campaignId];
                
                // Si es la transición Última Recolección -> Cierre, abre el modal de kilos
                if (currentStatus === 'Última Recolección') {
                    openKilosModal(campaign);
                    return;
                }

                // Para todas las demás transiciones, abre el modal de avance/comentario
                openAdvanceCommentModal(campaign, nextPhase);
            };

            // Modal para captura de Kilos
            const openKilosModal = (campaign) => {
                const modal = document.getElementById('kilos-modal');
                document.getElementById('kilos-modal-title').textContent = `Transición a Cierre: ${campaign.name}`;
                document.getElementById('kilos-campaign-id').value = campaign.id;
                document.getElementById('kilos-next-phase').value = 'Cierre'; 
                modal.classList.remove('hidden', 'opacity-0');
                modal.classList.add('opacity-100');
            };

            document.getElementById('kilos-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const campaignId = document.getElementById('kilos-campaign-id').value;
                const nextPhase = document.getElementById('kilos-next-phase').value;
                const comment = document.getElementById('campaign-kilos-comment').value || 'Campaña cerrada al registrar kilos.';
                const kilos = parseFloat(document.getElementById('campaign-kilos-input').value);
                const campaign = campaignsData[campaignId];

                if (isNaN(kilos) || kilos < 0) {
                    alertModal("Error de Kilos", "Por favor, introduce una cantidad válida y positiva de kilos.");
                    return;
                }

                const now = new Date().toISOString();
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'campaigns', campaignId);

                try {
                    await updateDoc(docRef, {
                        totalKilos: kilos,
                        status: nextPhase,
                        endDate: now,
                        [`phases.${nextPhase}`]: { date: now, comment: comment } 
                    });
                    
                    document.getElementById('kilos-modal').classList.add('hidden', 'opacity-0');
                    document.getElementById('kilos-modal').classList.remove('opacity-100');
                    e.target.reset();
                    alertModal("Campaña Cerrada", `La campaña "${campaign.name}" ha sido cerrada con ${kilos} Kg.`);
                } catch (error) {
                    console.error("Error al cerrar campaña y actualizar kilos:", error);
                    alertModal("Error", "No se pudo finalizar la campaña con los kilos recolectados.");
                }
            });


            // Modal para comentarios de avance (excepto cierre)
            const openAdvanceCommentModal = (campaign, nextPhase) => {
                const modal = document.getElementById('advance-comment-modal');
                document.getElementById('advance-comment-modal-title').textContent = `Avanzar a: ${nextPhase}`;
                document.getElementById('advance-campaign-name-display').textContent = campaign.name;
                
                document.getElementById('advance-campaign-id').value = campaign.id;
                document.getElementById('advance-next-phase').value = nextPhase;
                document.getElementById('advance-comment-input').value = ''; 
                
                modal.classList.remove('hidden', 'opacity-0');
                modal.classList.add('opacity-100');
            };

            document.getElementById('advance-comment-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const campaignId = document.getElementById('advance-campaign-id').value;
                const nextPhase = document.getElementById('advance-next-phase').value;
                const comment = document.getElementById('advance-comment-input').value;

                processPhaseAdvancement(campaignId, nextPhase, comment);
            });

            // Función para procesar el avance de fase con comentario
            window.processPhaseAdvancement = async (campaignId, nextPhase, comment) => {
                const now = new Date().toISOString();
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'campaigns', campaignId);
                const updateData = {
                    status: nextPhase,
                    [`phases.${nextPhase}`]: { date: now, comment: comment || 'Sin comentarios logísticos.' }
                };

                try {
                    await updateDoc(docRef, updateData);
                    document.getElementById('advance-comment-modal').classList.add('hidden', 'opacity-0');
                    document.getElementById('advance-comment-modal').classList.remove('opacity-100');
                    alertModal("Fase Avanzada", `Campaña actualizada a la fase: "${nextPhase}" con nota.`);
                } catch (error) {
                    console.error("Error al actualizar la fase con comentario:", error);
                    alertModal("Error", `No se pudo avanzar la fase de la campaña.`);
                }
            };
            
            // Función para editar fecha
            window.openEditDateModal = (campaignId, phaseName, phaseData) => {
                const modal = document.getElementById('edit-date-modal');
                
                const currentPhaseDateISO = getPhaseDate({phases: {[phaseName]: phaseData}}, phaseName);

                let localDateTime = '';
                if (currentPhaseDateISO) {
                    const d = new Date(currentPhaseDateISO);
                    // Formatea la fecha y hora para el input local (YYYY-MM-DDTHH:MM)
                    localDateTime = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
                }
                
                document.getElementById('edit-date-modal-title').textContent = `Editar Fecha de: ${phaseName}`;
                document.getElementById('edit-campaign-id').value = campaignId;
                document.getElementById('edit-phase-name').value = phaseName;
                document.getElementById('edit-phase-date').value = localDateTime;
                document.getElementById('edit-phase-comment').value = phaseData.comment || '';

                modal.classList.remove('hidden', 'opacity-0');
                modal.classList.add('opacity-100');
            };

            document.getElementById('edit-date-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const campaignId = document.getElementById('edit-campaign-id').value;
                const phaseName = document.getElementById('edit-phase-name').value;
                const newDateLocal = document.getElementById('edit-phase-date').value;
                const newComment = document.getElementById('edit-phase-comment').value || 'Sin comentarios logísticos.';

                if (!newDateLocal) {
                    alertModal("Error", "Por favor, selecciona una fecha y hora válidas.");
                    return;
                }
                
                const newDateISO = new Date(newDateLocal).toISOString();
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'campaigns', campaignId);

                const updatePhaseData = { date: newDateISO, comment: newComment };
                const updateData = { [`phases.${phaseName}`]: updatePhaseData };
                
                if (phaseName === 'Inicio de Campaña') {
                    updateData.startDate = newDateISO;
                }
                if (phaseName === 'Cierre') {
                    updateData.endDate = newDateISO;
                }

                try {
                    await updateDoc(docRef, updateData);
                    document.getElementById('edit-date-modal').classList.add('hidden', 'opacity-0');
                    document.getElementById('edit-date-modal').classList.remove('opacity-100');
                    alertModal("Fecha Actualizada", `La fecha y nota de la fase "${phaseName}" han sido modificadas.`);
                } catch (error) {
                    console.error("Error al actualizar la fecha de la fase:", error);
                    alertModal("Error", "No se pudo actualizar la fecha de la fase.");
                }
            });

            // Modal para ver comentarios
            window.viewPhaseComment = (phaseName, comment) => {
                alertModal(`Nota de la Fase: ${phaseName}`, comment || 'No se registraron comentarios para esta fase.');
            };

            // ----------------------------------------------------------------
            // Funciones de Automatización (Agendar e WP)
            // ----------------------------------------------------------------
            
            // Función genérica para ICS (usa phaseDataString)
            window.generateIcsForPhase = (campaignJsonString, phaseName, phaseDataString) => {
                const campaign = JSON.parse(campaignJsonString);
                const phaseData = JSON.parse(phaseDataString); // FIX: Ahora parsea la cadena JSON correctamente
                const start = new Date(phaseData.date);
                const end = new Date(start.getTime() + 60 * 60 * 1000); 
                const phaseDateDisplay = start.toLocaleDateString('es-MX');

                const description = `Campaña: ${campaign.name}\\nContacto: ${campaign.contact}\\nUbicación: ${campaign.location}\\nEvento: ${phaseName}\\nNota Logística: ${phaseData.comment || 'N/A'}`;
                
                // ... Resto de la lógica ICS ...
                const icsContent = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'PRODID:-//Campaign Tracker App//NONSGML v1.0//EN',
                    'BEGIN:VEVENT',
                    `UID:${campaign.id}-${phaseName}-${Date.now()}`,
                    `DTSTAMP:${formatDateTime(new Date())}`,
                    `DTSTART:${formatDateTime(start)}`,
                    `DTEND:${formatDateTime(end)}`,
                    `SUMMARY:Evento de Campaña (${phaseName}): ${campaign.name}`,
                    `LOCATION:${campaign.location}`,
                    `DESCRIPTION:${description}`,
                    'END:VEVENT',
                    'END:VCALENDAR'
                ].join('\n');

                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `${phaseName}_Campaña_${campaign.name.replace(/\s/g, '_')}_${phaseDateDisplay.replace(/\//g, '-')}.ics`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                alertModal("Cita Agendada", `Se ha descargado el archivo .ics para el evento "${phaseName}".`);
            };

            // Función genérica para WP (usa phaseDataString)
            window.sendWhatsAppMessageForPhase = (campaignJsonString, phaseName, phaseDataString) => {
                const campaign = JSON.parse(campaignJsonString);
                const phaseData = JSON.parse(phaseDataString); // FIX: Ahora parsea la cadena JSON correctamente
                const phaseDateDisplay = new Date(phaseData.date).toLocaleDateString('es-MX');
                
                const message = `¡Hola! Solo para confirmar que la fase *${phaseName}* de la campaña "${campaign.name}" fue completada exitosamente el ${phaseDateDisplay}. %0A%0ANota Logística: ${phaseData.comment || 'Sin notas.'}`;

                const phone = campaign.phone; 
                if (!phone) {
                    alertModal("Error de Contacto", "El número de contacto no está registrado para esta campaña.");
                    return;
                }
                const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;

                window.open(whatsappUrl, '_blank');
                alertModal("Mensaje de WhatsApp", `Se ha abierto una nueva ventana para enviar el mensaje a ${phone} sobre la fase "${phaseName}".`);
            };

            // Las funciones de cierre (CierreICS y CierreWP) se mantienen para incluir las métricas finales (simplificadas aquí para espacio)
            window.sendWhatsAppMessageForCierre = (campaignJsonString) => {
                const campaign = JSON.parse(campaignJsonString);
                const phaseData = campaign.phases['Cierre'];
                const phaseDateDisplay = new Date(phaseData.date).toLocaleDateString('es-MX');

                const message = `¡Campaña *${campaign.name}* Finalizada! %0A%0AFecha de Cierre: ${phaseDateDisplay}%0ATotal de Kilos Recolectados: ${campaign.totalKilos} Kg.%0AGracias por tu colaboración.`;

                const phone = campaign.phone; 
                if (!phone) {
                    alertModal("Error de Contacto", "El número de contacto no está registrado para esta campaña.");
                    return;
                }
                const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;

                window.open(whatsappUrl, '_blank');
            };

            window.generateIcsForCierre = (campaignJsonString) => {
                const campaign = JSON.parse(campaignJsonString);
                const phaseData = campaign.phases['Cierre'];
                
                const start = new Date(phaseData.date);
                const end = new Date(start.getTime() + 60 * 60 * 1000); 
                const phaseDateDisplay = start.toLocaleDateString('es-MX');

                const description = `Campaña: ${campaign.name}\\nTotal Kilos: ${campaign.totalKilos} Kg.\\nNota de Cierre: ${phaseData.comment || 'N/A'}`;
                
                // ... Lógica ICS ...
                const icsContent = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'PRODID:-//Campaign Tracker App//NONSGML v1.0//EN',
                    'BEGIN:VEVENT',
                    `UID:${campaign.id}-Cierre-${Date.now()}`,
                    `DTSTAMP:${formatDateTime(new Date())}`,
                    `DTSTART:${formatDateTime(start)}`,
                    `DTEND:${formatDateTime(end)}`,
                    `SUMMARY:Cierre de Campaña: ${campaign.name}`,
                    `LOCATION:${campaign.location}`,
                    `DESCRIPTION:${description}`,
                    'END:VEVENT',
                    'END:VCALENDAR'
                ].join('\n');

                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `Cierre_Campaña_${campaign.name.replace(/\s/g, '_')}_${phaseDateDisplay.replace(/\//g, '-')}.ics`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                alertModal("Cita Agendada", `Se ha descargado el archivo .ics para el cierre de la campaña.`);
            };


            // ----------------------------------------------------------------
            // Lógica de Renderizado
            // ----------------------------------------------------------------
            const renderCampaigns = (campaigns, container, type) => {
                container.innerHTML = ''; 
                
                campaigns.sort((a, b) => new Date(getPhaseDate(b, 'Inicio de Campaña') || b.startDate) - new Date(getPhaseDate(a, 'Inicio de Campaña') || a.startDate)); 

                if (campaigns.length === 0) {
                    const message = type === 'activas' ? 
                        `¡No hay campañas activas! Inicia una nueva campaña para verla aquí.` :
                        `Las campañas cerradas aparecerán aquí.`;
                    container.innerHTML = `<p class="text-gray-500 text-center p-6 bg-white rounded-xl">${message}</p>`;
                    return;
                }

                campaigns.forEach(campaign => {
                    const startDateISO = getPhaseDate(campaign, 'Inicio de Campaña') || campaign.startDate;
                    const endDateISO = getPhaseDate(campaign, 'Cierre') || campaign.endDate;
                    const durationDays = calculateDuration(startDateISO, endDateISO);
                    const isCompleted = campaign.status === 'Cierre';
                    const currentIndex = PHASES.indexOf(campaign.status);
                    const nextPhase = PHASES[currentIndex + 1];

                    const efficiency = (campaign.totalKilos > 0 && durationDays > 0) ? (durationDays / campaign.totalKilos).toFixed(2) : 'N/A';
                    let efficiencyText = '';
                    if (isCompleted) {
                        const efficiencyValue = parseFloat(efficiency);
                        const efficiencyClass = efficiency !== 'N/A' && efficiencyValue > 0 && efficiencyValue < 0.5 ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800';
                        efficiencyText = `
                            <div class="flex flex-col items-end">
                                <span class="text-sm text-gray-700">Eficiencia (Días/Kg):</span>
                                <span class="text-[0.8rem] font-bold ${efficiencyClass} rounded-md px-2 py-0.5">
                                    ${efficiency}
                                </span>
                            </div>
                        `;
                    }

                    // Se sigue usando para el cierre
                    const campaignJsonString = JSON.stringify(campaign).replace(/"/g, '&quot;');

                    // Renderizar las fases del proceso (Timeline)
                    const phasesHTML = PHASES.map(phase => {
                        const isCurrent = phase === campaign.status;
                        const phaseData = campaign.phases && campaign.phases[phase]; 
                        const isDone = !!phaseData;
                        const phaseClass = isDone ? 'phase-complete' : (isCurrent ? 'phase-active' : 'bg-gray-200 text-gray-700');
                        const phaseDateISO = getPhaseDate({phases: {[phase]: phaseData}}, phase);

                        const phaseDateDisplay = isDone ? new Date(phaseDateISO).toLocaleDateString('es-MX', {day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'}) : 'Pendiente';

                        // FIX: Escapar la cadena JSON para que sea válida dentro del atributo onclick
                        // Usamos JSON.stringify y luego reemplazamos las comillas dobles (") por entidades HTML (&quot;) 
                        // para que el HTML lo lea como una cadena literal y JSON.parse() lo interprete luego.
                        const phaseDataString = isDone ? JSON.stringify(phaseData).replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';
                        
                        const hasComment = isDone && phaseData.comment && phaseData.comment !== 'Sin comentarios iniciales.' && phaseData.comment !== 'Sin comentarios logísticos.' && phaseData.comment !== 'Campaña cerrada al registrar kilos.';

                        // Íconos de acción para fases completadas
                        const actionIcons = isDone ? `
                            <div class="flex justify-center mt-1 space-x-1">
                                <!-- Botón de Editar Fecha/Nota -->
                                <button title="Editar Fecha y Nota de ${phase}" 
                                    onclick="window.openEditDateModal('${campaign.id}', '${phase}', ${JSON.stringify(phaseData).replace(/"/g, '&quot;').replace(/'/g, '&#39;')})" 
                                    class="text-gray-600 hover:text-indigo-600 p-0.5 rounded-full hover:bg-gray-100 transition-colors duration-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3"><path d="M14.5 0l10.5 10.5-12 12-10.5-10.5 12-12zm-8 16.5l-5 5-2.5-2.5 5-5z"/></svg>
                                </button>
                                <!-- Botón de Agendar (ICS) -->
                                <button title="Agendar ${phase}" 
                                    onclick="window.generateIcsForPhase('${campaignJsonString}', '${phase}', '${phaseDataString}')" 
                                    class="text-blue-600 hover:text-blue-800 p-0.5 rounded-full hover:bg-gray-100 transition-colors duration-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3"><path d="M19 4h-1V3a1 1 0 0 0-2 0v1H8V3a1 1 0 0 0-2 0v1H5a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3zm1 15a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9h16zm-8-3h-2v-2h2zm-4 0H8v-2h2zm8 0h-2v-2h2z"/></svg>
                                </button>
                                <!-- Botón de WhatsApp -->
                                <button title="Enviar WP ${phase}" 
                                    onclick="window.sendWhatsAppMessageForPhase('${campaignJsonString}', '${phase}', '${phaseDataString}')" 
                                    class="text-green-600 hover:text-green-800 p-0.5 rounded-full hover:bg-gray-100 transition-colors duration-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3"><path d="M12.001 2.001c-5.522 0-9.999 4.477-9.999 9.999 0 1.948.556 3.766 1.517 5.334l-1.071 3.931 4.015-1.05c1.45 7.994 3.238 1.45 5.538 1.45 5.522 0 9.999-4.477 9.999-9.999s-4.477-9.999-9.999-9.999zm4.01 13.911c-.131.258-.45.333-.717.202-1.04-.509-2.483-1.12-2.731-1.22-.249-.1-.43-.175-.605.116-.296.483-.574.929-.817 1.255-.244.327-.492.36-.931.134-1.398-.727-2.316-1.503-3.151-2.924-.766-1.319-.884-2.529-.688-2.92.196-.39.42-.58.625-.795.205-.215.42-.486.634-.73.213-.242.279-.475.438-.344.159.131.996 2.404 1.096 2.652.1.248.165.297.35.666.183.369.309.394.512.333.203-.06-.81-1.309-1.006-1.557-.197-.248-.184-.447-.257-.645-.072-.199-.026-.379.131-.563 0 0 1.284-1.503 1.761-1.892.477-.389.988-.508 1.498-.508s.995.049 1.472.645c.476.596.883 1.83.996 2.078.113.248.113.483-.021.741z"/></svg>
                                </button>
                                ${hasComment ? `
                                    <!-- Botón de Ver Comentario -->
                                    <button title="Ver Nota Logística" 
                                        onclick="window.viewPhaseComment('${phase}', '${phaseData.comment.replace(/'/g, '&#39;')}')" 
                                        class="text-yellow-600 hover:text-yellow-800 p-0.5 rounded-full hover:bg-gray-100 transition-colors duration-100">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3"><path d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2zm0 18c4.411 0 8-3.589 8-8s-3.589-8-8-8-8 3.589-8 8 3.589 8 8 8zm-1-10v5h2v-5h-2zm0-2h2v1h-2v-1z"/></svg>
                                    </button>
                                `: ''}
                            </div>
                        ` : '';

                        return `
                            <div class="flex-1 text-center text-xs transition-colors duration-200 ${phaseClass} timeline-item rounded-lg shadow-sm">
                                <div class="font-semibold text-[0.7rem] truncate">${phase}</div>
                                <div class="text-[0.6rem] opacity-80 mb-1">${phaseDateDisplay}</div>
                                ${actionIcons}
                            </div>
                        `;
                    }).join('');


                    // Contenido de la Tarjeta
                    const cardHTML = `
                        <div class="campaign-card bg-white p-4 rounded-xl mb-4 border border-gray-100 shadow-lg" data-id="${campaign.id}">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-xl font-bold text-gray-800">${campaign.name}</h3>
                                <div class="text-sm font-semibold p-1 rounded-full px-3 ${isCompleted ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                    ${isCompleted ? 'CERRADA' : 'ACTIVA'}
                                </div>
                            </div>
                            
                            <!-- Indicadores Generales -->
                            <p class="text-sm text-gray-600 mb-1">
                                <span class="font-semibold">Contacto:</span> ${campaign.contact}
                            </p>
                            <p class="text-sm text-gray-600 mb-2">
                                <span class="font-semibold">Teléfono:</span> ${campaign.phone || 'N/A'}
                            </p>
                            <div class="flex justify-between items-center mb-4 text-sm text-gray-600 border-b pb-2">
                                <p>
                                    <span class="font-semibold">Ubicación:</span> ${campaign.location}
                                </p>
                                ${isCompleted ? `
                                    <p class="font-bold text-indigo-700">
                                        ${campaign.totalKilos} <span class="font-normal text-gray-600">Kg</span>
                                    </p>
                                ` : ''}
                            </div>
                            
                            <!-- Timeline de Fases con Íconos de Acción -->
                            <div class="flex space-x-1 mb-4 border-t pt-3 timeline-item-container">
                                ${phasesHTML}
                            </div>

                            <!-- Estado Actual y Duración / Métricas de Eficiencia -->
                            <div class="flex justify-between items-center text-sm font-medium mb-4 p-3 ${isCompleted ? 'bg-green-50' : 'bg-blue-50'} rounded-lg">
                                <div class="${isCompleted ? 'text-green-700' : 'text-blue-700'}">
                                    ${isCompleted ? 'Duración Total:' : 'Fase Actual:'} <span class="font-bold">${isCompleted ? `${durationDays} días` : campaign.status}</span>
                                </div>
                                ${efficiencyText || `<div class="text-gray-600">
                                    Duración: <span class="font-bold">${durationDays} días</span>
                                </div>`}
                            </div>

                            <!-- Botones de Acción / Cierre -->
                            ${!isCompleted ? `
                                <button onclick="window.advancePhase('${campaign.id}', '${campaign.status}')"
                                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-lg transition duration-150 shadow-md">
                                    Avanzar a: ${nextPhase}
                                </button>
                            ` : `
                                <div class="flex space-x-2">
                                    <button onclick="window.sendWhatsAppMessageForCierre('${campaignJsonString}')"
                                            class="w-1/2 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg transition duration-150 shadow-md flex items-center justify-center text-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-1"><path d="M12.001 2.001c-5.522 0-9.999 4.477-9.999 9.999 0 1.948.556 3.766 1.517 5.334l-1.071 3.931 4.015-1.05c1.45 7.994 3.238 1.45 5.538 1.45 5.522 0 9.999-4.477 9.999-9.999s-4.477-9.999-9.999-9.999zm4.01 13.911c-.131.258-.45.333-.717.202-1.04-.509-2.483-1.12-2.731-1.22-.249-.1-.43-.175-.605.116-.296.483-.574.929-.817 1.255-.244.327-.492.36-.931.134-1.398-.727-2.316-1.503-3.151-2.924-.766-1.319-.884-2.529-.688-2.92.196-.39.42-.58.625-.795.205-.215.42-.486.634-.73.213-.242.279-.475.438-.344.159.131.996 2.404 1.096 2.652.1.248.165.297.35.666.183.369.309.394.512.333.203-.06-.81-1.309-1.006-1.557-.197-.248-.184-.447-.257-.645-.072-.199-.026-.379.131-.563 0 0 1.284-1.503 1.761-1.892.477-.389.988-.508 1.498-.508s.995.049 1.472.645c.476.596.883 1.83.996 2.078.113.248.113.483-.021.741z"/></svg>
                                        Enviar WP (Final)
                                    </button>
                                    <button onclick="window.generateIcsForCierre('${campaignJsonString}')"
                                            class="w-1/2 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg transition duration-150 shadow-md flex items-center justify-center text-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-1"><path d="M19 4h-1V3a1 1 0 0 0-2 0v1H8V3a1 1 0 0 0-2 0v1H5a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3zm1 15a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9h16zm-8-3h-2v-2h2zm-4 0H8v-2h2zm8 0h-2v-2h2z"/></svg>
                                        Agendar Cierre
                                    </button>
                                </div>
                            `}
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', cardHTML);
                });
            };
            
            // Función para Modal (Reemplaza a alert())
            const alertModal = (title, message) => {
                const modal = document.getElementById('custom-modal');
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;
                modal.classList.remove('hidden', 'opacity-0');
                modal.classList.add('opacity-100'); 
                
                const timer = setTimeout(() => {
                    modal.classList.remove('opacity-100');
                    modal.classList.add('opacity-0');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }, 4000); 

                const closeButton = document.getElementById('modal-close');
                closeButton.onclick = () => {
                    clearTimeout(timer);
                    modal.classList.remove('opacity-100');
                    modal.classList.add('opacity-0');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                };
            };
            
            // Cerrar modales al hacer clic fuera
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal-backdrop')) {
                        backdrop.classList.add('hidden', 'opacity-0');
                        backdrop.classList.remove('opacity-100');
                    }
                });
            });

        } catch (e) {
            console.error("⛔ ERROR CRÍTICO AL INICIALIZAR LA APP:", e);
            document.getElementById('active-campaigns-list').innerHTML = `
                <p class="text-center text-red-600 font-bold p-6 bg-red-100 rounded-xl">
                    Error al cargar la aplicación. Revisa la consola (F12) para ver el error de inicialización.
                    <span class="block mt-2 text-xs font-normal">${e.message || 'Error desconocido'}</span>
                </p>
            `;
        }
    </script>

    <!-- Contenedor Principal -->
    <div class="max-w-md mx-auto p-4 sm:p-6">
        <header class="mb-6 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-1">
                Seguimiento de Campañas
            </h1>
            <p id="user-id-display" class="text-xs text-gray-500">
                ID de Usuario: Cargando...
            </p>
        </header>

        <!-- Formulario para Agregar Campaña -->
        <div class="bg-white p-5 rounded-xl mb-6 shadow-lg border border-indigo-100">
            <h2 class="text-xl font-semibold text-indigo-700 mb-4">
                Nueva Campaña
            </h2>
            <form id="add-campaign-form" class="space-y-3">
                <input type="text" id="campaign-name" placeholder="Nombre de la Campaña (Ej: Navidad 2024)" required
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                
                <input type="text" id="campaign-contact" placeholder="Contacto Principal" required
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <input type="tel" id="campaign-phone" placeholder="Número de Contacto (Ej: +525512345678)" required
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                
                <input type="text" id="campaign-location" placeholder="Ubicación General" required
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                
                <textarea id="campaign-comments" placeholder="Comentarios iniciales de la campaña (opcional)..." rows="2"
                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                
                <button type="submit"
                        class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 rounded-lg transition duration-150 shadow-md">
                    Iniciar Campaña
                </button>
            </form>
        </div>

        <!-- Lista de Campañas Activas -->
        <h2 class="text-2xl font-bold text-gray-900 mt-8 mb-4 border-b pb-2">
            Campañas Activas (Pendientes)
        </h2>
        <div id="active-campaigns-list">
            <p class="text-center text-gray-500 p-6">Cargando campañas...</p>
        </div>

        <!-- Lista de Campañas Cerradas -->
        <h2 class="text-2xl font-bold text-gray-900 mt-8 mb-4 border-b pb-2 text-gray-600">
            Campañas Cerradas
        </h2>
        <div id="closed-campaigns-list">
            <p class="text-center text-gray-500 p-6">Cargando campañas...</p>
        </div>
    </div>

    <!-- 1. Custom Modal para Mensajes (Reemplaza alert()) -->
    <div id="custom-modal" class="modal-backdrop hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center transition-opacity duration-300 opacity-0 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300">
            <h3 id="modal-title" class="text-lg font-bold mb-2 text-indigo-700">Título</h3>
            <p id="modal-message" class="text-sm text-gray-600 mb-4">Mensaje</p>
            <button id="modal-close" class="w-full bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600 transition">Aceptar</button>
        </div>
    </div>

    <!-- 2. Modal para Captura de Kilos (Última Recolección -> Cierre) -->
    <div id="kilos-modal" class="modal-backdrop hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center transition-opacity duration-300 opacity-0 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300">
            <h3 id="kilos-modal-title" class="text-lg font-bold mb-4 text-indigo-700">Cerrar Campaña</h3>
            <form id="kilos-form">
                <p class="text-sm text-gray-600 mb-4">Introduce el total de kilos recolectados para finalizar la campaña.</p>
                <input type="hidden" id="kilos-campaign-id">
                <input type="hidden" id="kilos-next-phase" value="Cierre">
                <label class="block text-sm font-medium text-gray-700 mb-1">Kilos Recolectados</label>
                <input type="number" id="campaign-kilos-input" placeholder="Ej: 150.5" required step="0.01" min="0"
                       class="w-full p-2 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                
                <label class="block text-sm font-medium text-gray-700 mb-1">Nota de Cierre (Opcional)</label>
                <textarea id="campaign-kilos-comment" placeholder="Comentarios de cierre o balance final." rows="2"
                    class="w-full p-2 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>

                <button type="submit" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition font-semibold">
                    Confirmar Kilos y Cerrar Campaña
                </button>
            </form>
        </div>
    </div>
    
    <!-- 3. Modal para Avance de Fase y Comentario -->
    <div id="advance-comment-modal" class="modal-backdrop hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center transition-opacity duration-300 opacity-0 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300">
            <h3 id="advance-comment-modal-title" class="text-lg font-bold mb-2 text-indigo-700">Avanzar Fase</h3>
            <p class="text-sm text-gray-600 mb-3">Campaña: <span id="advance-campaign-name-display" class="font-semibold"></span></p>
            <form id="advance-comment-form">
                <p class="text-sm text-gray-600 mb-4">La fecha actual se registrará como la fecha de inicio de esta nueva fase. Agrega una nota logística si es necesario.</p>
                <input type="hidden" id="advance-campaign-id">
                <input type="hidden" id="advance-next-phase">
                
                <label class="block text-sm font-medium text-gray-700 mb-1">Nota Logística (Opcional)</label>
                <textarea id="advance-comment-input" placeholder="Ej: Hubo un retraso por tráfico, se ajustó la hora de entrega." rows="3"
                    class="w-full p-2 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                
                <button type="submit" class="w-full bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600 transition font-semibold">
                    Confirmar Avance y Guardar Nota
                </button>
            </form>
        </div>
    </div>

    <!-- 4. Modal para Editar Fecha/Nota de Fase -->
    <div id="edit-date-modal" class="modal-backdrop hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center transition-opacity duration-300 opacity-0 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300">
            <h3 id="edit-date-modal-title" class="text-lg font-bold mb-4 text-indigo-700">Editar Fecha de Fase</h3>
            <form id="edit-date-form">
                <p class="text-sm text-gray-600 mb-4">Modifica la fecha y/o la nota de esta fase.</p>
                <input type="hidden" id="edit-campaign-id">
                <input type="hidden" id="edit-phase-name">
                
                <label class="block text-sm font-medium text-gray-700 mb-1">Nueva Fecha y Hora</label>
                <input type="datetime-local" id="edit-phase-date" required
                       class="w-full p-2 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">

                <label class="block text-sm font-medium text-gray-700 mb-1">Nota Logística</label>
                <textarea id="edit-phase-comment" placeholder="Comentario anterior..." rows="3"
                    class="w-full p-2 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                
                <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition font-semibold">
                    Guardar Cambios
                </button>
            </form>
        </div>
    </div>


</body>
</html>